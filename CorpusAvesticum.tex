%% CorpusAvesticum.tex
%% Copyright 2018-2022 Martin Sievers
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Martin Sievers
%
% This work consists of the files 
% brill.cls
% brill.lua
% CorpusAvesticum.tex
% muya.bbx
% muya.cbx
% muya.dbx
% muya.lua
% xindex-brill.lua
% xindex-muya.lua
% xindex-muyaPassages.lua
%%
\ProvidesFile{CorpusAvesticum.tex}%
   [2022/09/01 v1.3.0 Configuration file for brill]
\RequirePackage{xspace}
\RequirePackage{collcell}
\RequirePackage{newunicodechar}
\newfontfamily{\freeserif}{FreeSerif}%
[%
   Extension      = .otf,%
   UprightFont    = *,%
   BoldFont       = *Bold,%
   ItalicFont     = *Italic,%
   BoldItalicFont = *BoldItalic,%
   Scale          = MatchLowercase,%
   Ligatures      = {Common},%
   Renderer       = Node,%
]% 
\newfontfamily{\freesans}{FreeSans}%
[%
   Extension      = .otf,%
   UprightFont    = *,%
   BoldFont       = *Bold,%
   ItalicFont     = *Oblique,%
   BoldItalicFont = *BoldOblique,%
   Scale          = MatchLowercase,%
   Ligatures      = {Common},%
   Renderer       = Node,%
]% 
\newfontfamily{\avestanfont}{NotoSansAvestan}%
[%
   Extension      = .ttf,%
   UprightFont    = *-Regular,%
   Scale          = MatchLowercase,%
   Ligatures      = {Common},%
   Renderer       = Harfbuzz,%
   Script         = Avestan,%
]%
\newfontfamily{\gujaratifont}{NotoSerifGujarati}%
[%
   Extension      = .ttf,%
   UprightFont    = *-Regular,%
   BoldFont       = *-Bold,%
   Scale          = MatchLowercase,%
   Renderer       = Harfbuzz,%
   Script         = Gujarati,%
]%
\newfontfamily{\arabicfont}{NotoNaskhArabic}%
[%
   Extension      = .ttf,%
   UprightFont    = *-Regular,%
   BoldFont       = *-Bold,%
   Scale          = MatchLowercase,%
   Ligatures      = {Common},%
   Renderer       = Harfbuzz,%
   Script         = Arabic,%
]%
\newfontfamily{\sanskritfont}{NotoSerifDevanagari}%
[%
   Extension      = .ttf,%
   UprightFont    = *-Regular,%
   BoldFont       = *-Bold,%
   Scale          = MatchLowercase,%
   Renderer       = Harfbuzz,%
   Script         = Devanagari,%
]%
\newfontfamily{\pahlavifont}{Khusro}%
[%
   Extension      = .ttf,%
   UprightFont    = *,%
   Scale          = MatchLowercase,%
]%
\newfontfamily{\syriacfont}{NotoSansSyriac}%
[%
   Extension      = .ttf,%
   UprightFont    = *-Regular,%
   BoldFont       = *-Black,%
   Scale          = MatchLowercase,%
   Renderer       = Harfbuzz,%
   Script         = Syriac,%
]%

\newcommand{\textarabic}[1]{%
   \bgroup\microtypesetup{activate=false}\textdir TRT\arabicfont #1\egroup}
\newcommand{\textavestan}[1]{%
   \bgroup\microtypesetup{activate=false}\textdir TRT\avestanfont #1\egroup}
\newcommand{\textgujarati}[1]{%
   \bgroup\microtypesetup{activate=false}\gujaratifont #1\egroup}
\newcommand{\textpahlavi}[1]{%
   \bgroup\microtypesetup{activate=false}\textdir TRT\pahlavifont #1\egroup}
\newcommand{\textsanskrit}[1]{%
   \bgroup\microtypesetup{activate=false}\sanskritfont #1\egroup}
\newcommand{\textsyriac}[1]{%
   \bgroup\microtypesetup{activate=false}\syriacfont #1\egroup}

\newcommand*{\aee}{ǝ̄}
\newcommand*{\XVE}{x\realsuperscript{v}}%\ifdefstring{\f@shape}{it}{\kern-1pt}{}}
\newcommand*{\NGVE}{ŋ\realsuperscript{v}}%\ifdefstring{\f@shape}{it}{\kern-1pt}{}}
\newcommand*{\shinthreedots}{%
   \ifdefstring{\f@shape}{it}
   {\ensuremath{\stackrel%
      {\text{\raisebox{-1.5ex}[0pt][0pt]{\hspace{0.3em}\syriacfont\symbol{"0745}}}}%
      {\text{š}}}%
   }%
   {\ensuremath{\stackrel%
      {\text{\raisebox{-1.5ex}[0pt][0pt]{\syriacfont\symbol{"0745}}}}%
      {\text{š}}}%
   }%
}

\newcommand*{\AvA}{\symbol{"10B00}}
\newcommand*{\AvAA}{\symbol{"10B01}}
\newcommand*{\AvAO}{\symbol{"10B02}}
\newcommand*{\AvAAO}{\symbol{"10B03}}
\newcommand*{\AvAN}{\symbol{"10B04}}
\newcommand*{\AvAAN}{\symbol{"10B05}}
\newcommand*{\AvAE}{\symbol{"10B06}}
\newcommand*{\AvAEE}{\symbol{"10B07}}
\newcommand*{\AvE}{\symbol{"10B08}}
\newcommand*{\AvEE}{\symbol{"10B09}}
\newcommand*{\AvO}{\symbol{"10B0A}}
\newcommand*{\AvOO}{\symbol{"10B0B}}
\newcommand*{\AvI}{\symbol{"10B0C}}
\newcommand*{\AvII}{\symbol{"10B0D}}
\newcommand*{\AvU}{\symbol{"10B0E}}
\newcommand*{\AvUU}{\symbol{"10B0F}}
\newcommand*{\AvKE}{\symbol{"10B10}}
\newcommand*{\AvXE}{\symbol{"10B11}}
\newcommand*{\AvXYE}{\symbol{"10B12}}
\newcommand*{\AvXVE}{\symbol{"10B13}}
\newcommand*{\AvGE}{\symbol{"10B14}}
\newcommand*{\AvGGE}{\symbol{"10B15}}
\newcommand*{\AvGHE}{\symbol{"10B16}}
\newcommand*{\AvCE}{\symbol{"10B17}}
\newcommand*{\AvJE}{\symbol{"10B18}}
\newcommand*{\AvTE}{\symbol{"10B19}}
\newcommand*{\AvTHE}{\symbol{"10B1A}}
\newcommand*{\AvDE}{\symbol{"10B1B}}
\newcommand*{\AvDHE}{\symbol{"10B1C}}
\newcommand*{\AvTTE}{\symbol{"10B1D}}
\newcommand*{\AvPE}{\symbol{"10B1E}}
\newcommand*{\AvFE}{\symbol{"10B1F}}
\newcommand*{\AvBE}{\symbol{"10B20}}
\newcommand*{\AvBHE}{\symbol{"10B21}}
\newcommand*{\AvNGE}{\symbol{"10B22}}
\newcommand*{\AvNGYE}{\symbol{"10B23}}
\newcommand*{\AvNGVE}{\symbol{"10B24}}
\newcommand*{\AvNE}{\symbol{"10B25}}
\newcommand*{\AvNYE}{\symbol{"10B26}}
\newcommand*{\AvNNE}{\symbol{"10B27}}
\newcommand*{\AvME}{\symbol{"10B28}}
\newcommand*{\AvHME}{\symbol{"10B29}}
\newcommand*{\AvYYE}{\symbol{"10B2A}}
\newcommand*{\AvYE}{\symbol{"10B2B}}
\newcommand*{\AvVE}{\symbol{"10B2C}}
\newcommand*{\AvRE}{\symbol{"10B2D}}
\newcommand*{\AvLE}{\symbol{"10B2E}}
\newcommand*{\AvSE}{\symbol{"10B2F}}
\newcommand*{\AvZE}{\symbol{"10B30}}
\newcommand*{\AvSHE}{\symbol{"10B31}}
\newcommand*{\AvZHE}{\symbol{"10B32}}
\newcommand*{\AvSHYE}{\symbol{"10B33}}
\newcommand*{\AvSSHE}{\symbol{"10B34}}
\newcommand*{\AvHE}{\symbol{"10B35}}
\newcommand*{\AvAbbrev}{\symbol{"10B39}}
\newcommand*{\AvTTDOOD}{\symbol{"10B3A}}
\newcommand*{\AvSTDOOD}{\symbol{"10B3B}}
\newcommand*{\AvLTDOOD}{\symbol{"10B3C}}
\newcommand*{\AvLODOTD}{\symbol{"10B3D}}
\newcommand*{\AvLTROOR}{\symbol{"10B3E}}
\newcommand*{\AvLOROTR}{\symbol{"10B3F}}
%%% Special characters
%\newunicodechar{←}{{\freeserif\symbol{"2190}}}
%\newunicodechar{→}{{\freeserif\symbol{"2192}}}
\newunicodechar{〈}{\textlangle}% map U+2329 to U+27E8
\newunicodechar{〉}{\textrangle}% map U+232A to U+27E9
\newunicodechar{●}{{\freeserif\symbol{"25CF}}}
\newunicodechar{✓}{{\freeserif\symbol{"2713}}}
\newunicodechar{β}{ꞵ}
\newunicodechar{γ}{ɣ}
\newunicodechar{λ}{{\addfontfeature{StylisticSet=20}λ}}%
\newunicodechar{θ}{{\addfontfeature{StylisticSet=20}θ}}%ϑ
\newunicodechar{ϑ}{{\addfontfeature{StylisticSet=20}θ}}
\newunicodechar{χ}{ꭓ}
\newunicodechar{।}{\textsanskrit{।}}

%\newcommand{\DeclareUnicodeCharacter}[2]{%
%   \begingroup\lccode`|=\string"#1\relax
%   \lowercase{\endgroup\newunicodechar{|}}{#2}%
%}
%\DeclareUnicodeCharacter{0745}{\raisebox{.75ex}{{\negthinspace\syriacfont\symbol{"0745}}}}
%\newunicodechar{݅ }{\textsyriac{\symbol{"0745}}}
%%%
\newcommand*{\blackcircle}{●}
\renewcommand*{\checkmark}{✓}% from AMSmath
\newcommand*{\leftwardsarrow}{←}
\newcommand*{\rightwardsarrow}{→}
\newcommand*{\sectionsign}{§}
%%% remap from U+2329 to U+27E8 and from U+232A to U+27E9
%%% For Brill fonts v4.0 we need the SS 5 to get the same style
\newunicodechar{⟨}{{\addfontfeature{StylisticSet=5}⟨}}
\newunicodechar{⟩}{{\addfontfeature{StylisticSet=5}⟩}}% U+27E9
\renewcommand*{\textlangle}{{\addfontfeature{StylisticSet=5}⟨}}% U+27E8
\renewcommand*{\textrangle}{{\addfontfeature{StylisticSet=5}⟩}}% U+27E9

\directlua{require("muya")}
\ifbrill@countwords
   \directlua{dofile(kpse.find_file"word_count.lua")}
   \def\setwordthreshold#1{%
      \directlua{packagedata.word_count.set_threshold(\number#1)}%
   }
   \def\startwordcount{%
      \directlua{
         luatexbase.add_to_callback(
         "pre_linebreak_filter",
         packagedata.word_count.callback,
         "word_count"
         )
      }%
   }
   \def\stopwordcount{%
      \endgraf %% force paragraph
      \directlua{
         luatexbase.remove_from_callback(
         "pre_linebreak_filter",
         "word_count"
         )
      }%
   }
%%% This outputs the word count to stdout.
   \def\dumpwordcount{%
      \directlua{packagedata.word_count.dump_total_word_count()}
   }
%%% This returns the word count at the current position. Works only at
%%% the end of a paragraph.
   \def\currentwordcount{%
      \directlua{packagedata.word_count.current_word_count()}%
      \logwordcount
   }
%   \def\printwordcount{%
%      \directlua{packagedata.word_count.print_total_word_count()}%
%      \logwordcount
%   }
   \def\logwordcount{%
      \directlua{packagedata.word_count.print_total_word_count_to_log()}%
   }
\else
   \def\setwordthreshold#1{\@gobble}
   \let\startwordcount\relax
   \let\stopwordcount\relax
   \let\dumpwordcount\relax
   \let\currentwordcount\relax
   %   \let\printwordcount\relax
   \let\logwordcount\relax
\fi%

\renewrobustcmd*{\textsuperscript}[1]{%
   %   \edef\@tempsup{#1}%
   \Ifisinteger{#1}%
      {\realsuperscript{#1}}%
      {%
         \IfStrEqCase{#1}{%
            {+}{\realsuperscript{+}}%
            {=}{\realsuperscript{=}}%
            {(}{\realsuperscript{(}}%
            {)}{\realsuperscript{)}}%
            {nd}{\realsuperscript{nd}}%
            {rd}{\realsuperscript{rd}}%
            {st}{\realsuperscript{st}}%
            {th}{\realsuperscript{th}}%
            {x}{\realsuperscript{x}}%
         }[\fakesuperscript{#1}]%
      }%
}

\newsavebox\@titlebox
\newsavebox\@subtitlebox
\newlength{\@titleskip}
\newlength{\@subtitleskipbefore}
\newlength{\@subtitleskipafter}
\ifbrill@PhD
\renewcommand*{\maketitle}[1][1]{%
   \begin{titlepage}
   \setcounter{page}{%
      #1%
   }%
   \let\titlepage@restore\relax
   %\let\footnotesize\small
   \let\footnoterule\relax
   \let\footnote\thanks
   \renewcommand*\thefootnote{\@fnsymbol\c@footnote}%
   \let\@oldmakefnmark\@makefnmark
   \renewcommand*{\@makefnmark}{\rlap\@oldmakefnmark}%
   \setparsizes{\z@}{\z@}{\z@\@plus 1fil}\par@updaterelative
   {\centering
      {\usekomafont{title}\LARGE\@title\par}
      \ifx\@subtitle\@empty
      \vskip 3\baselineskip
      \else
         \vskip 2\baselineskip
         {\usekomafont{subtitle}\Large\@subtitle\par}
         \vskip 3\baselineskip
      \fi%
      {\usekomafont{author}\@author\par}
      \vskip 3\baselineskip
      \ifdefempty{\@degree}{}{\@degree\\}%
      \@date\par
      \vfill
      \ifdefempty{\@department}{}{\@department\\}%
      SOAS, University of London\par
   }%
   \ifdefempty{\@declarationPhD}{}{%
      \next@tdpage
      \@declarationPhD
   }%
   \ifx\@abstract\@empty
   \else%
      \next@tdpage%
      \@abstractheading%
      \@abstract%
   \fi%   
   \end{titlepage}
   \setcounter{footnote}{0}%
   \global\let\and\relax
}
\else
\renewcommand*{\maketitle}[1][1]{%
   \InputIfFileExists{titlepages.tex}%
      {\ClassInfo{brill}{Information for title pages successfully loaded}}%
      {\ClassWarningNoLine{brill}{Found no titlepage information.\MessageBreak
       Please check, whether you copied titlepages.tex correctly.}}%
   \def\and{\newline}
   \begin{titlepage}
      \setcounter{page}{%
        #1%
      }%
      \let\titlepage@restore\relax
      %\let\footnotesize\small
      \let\footnoterule\relax
      \let\footnote\thanks
      \renewcommand*\thefootnote{\@fnsymbol\c@footnote}%
      \let\@oldmakefnmark\@makefnmark
      \renewcommand*{\@makefnmark}{\rlap\@oldmakefnmark}%
      %%% Calculate title size
      \savebox{\@titlebox}{\parbox[b]{\textwidth}{\centering\usekomafont{title}{\fontsize{28bp}{33bp}\selectfont\@title\strut\par\kern-\prevdepth}}}%
      \savebox{\@subtitlebox}{\parbox[b]{\textwidth}{\centering\usekomafont{subtitle}{\fontsize{16bp}{20bp}\selectfont\@subtitle\strut\par\kern-\prevdepth}}}%
      \ifdimless{\ht\@titlebox}{30bp}{\setlength{\@titleskip}{-1.6bp}}{%
         \ifdimless{\ht\@titlebox}{60bp}{\setlength{\@titleskip}{5bp}}{\setlength{\@titleskip}{11.6bp}}%
      }
      \ifdimless{\ht\@subtitlebox}{20bp}{%
         \setlength{\@subtitleskipbefore}{0bp}%
         \setlength{\@subtitleskipafter}{2.8bp}%
      }{%
         \ifdimless{\ht\@subtitlebox}{40bp}{%
            \setlength{\@subtitleskipbefore}{3.2bp}%
            \setlength{\@subtitleskipafter}{9.6bp}%
         }{\setlength{\@subtitleskip}{10bp}}%
      }
      \ifx\@extratitle\@empty
        \ifx\@frontispiece\@empty
        \else
          \if@twoside\mbox{}\next@tpage\fi
          \vspace*{\dimexpr -\topskip\relax}%
          \@frontispiece\next@tdpage
        \fi
      \else
        \noindent\@extratitle
        \ifx\@frontispiece\@empty
        \else
          \next@tpage
          \vspace*{\dimexpr -\normalbaselineskip-\topskip-\dp\strutbox\relax}%
          \noindent\@frontispiece
        \fi%
        \next@tdpage
      \fi%
      \setparsizes{\z@}{\z@}{\z@\@plus 1fil}\par@updaterelative
      {\centering
         {\vspace*{-33bp}\usekomafont{title}{\fontsize{28bp}{33bp}\selectfont\@title\strut\par\kern-\prevdepth}}%
         %\vskip\@titleskip%
         \ifx\@subtitle\@empty%
            \vskip 4.7bp%
         \else%
            %\vskip\@subtitleskipbefore%  
            %\vskip -\dp\strutbox%
            \vspace{\dimexpr 2.0\normalbaselineskip+1bp\relax}%
            %\vskip 1bp%
            {%
               \usekomafont{subtitle}{\fontsize{16bp}{20bp}\selectfont\@subtitle\strut\par\kern-\prevdepth}%
            }%
            \vskip\@subtitleskipafter%  
         \fi%
         \vskip 3\baselineskip%
        {%
           \normalsize\itshape By\strut\par%
           \kern-\prevdepth%
        }%
        \vskip 1\baselineskip%
        {%
           \fontsize{14bp}{17bp}\selectfont\@author\strut\par%
           \kern-\prevdepth%
        }%
        \vfill
        \IfFileExists{\@titlelogofile}%
           {\includegraphics[scale=0.8]{\@titlelogofile}\par\vspace*{\baselineskip}}%
           {}
        {\normalsize\scshape LEIDEN\ |\ BOSTON\par}%
      }%
      \next@tpage
      \begin{addmargin}[-11mm]{-4mm}
      \begin{minipage}[t]{100mm}
         \footnotesize%
         \raggedright%
         \hyphenpenalty=\@M%
         \@uppertitleback%
      \end{minipage}%
      \vfill
      \begin{minipage}[b]{130mm}%
         \footnotesize%
         \raggedright%
         \hyphenpenalty=\@M%
         \@lowertitleback%
      \end{minipage}%
      \end{addmargin}\removelastskip%
      \vspace*{35mm}%
      \ifx\@dedication\@empty
      \else
        \next@tdpage\null\vfill
        {\centering
        {\usekomafont{dedication}{\fontsize{12bp}{13.2bp}\selectfont\@dedication\par}}%
        \vskip 3\baselineskip
        {\fontsize{24bp}{13.2bp}\selectfont\symbol{"2235}\par}}%
        \vspace*{22\baselineskip}%
        \cleardoubleemptypage
      \fi
      \ifx\titlepage@restore\relax\else\clearpage\titlepage@restore\fi
   \end{titlepage}
   \setcounter{footnote}{0}%
   \global\let\and\relax
}%
\fi%
\patchcmd{\imki@putindex}%
   {\immediate\closeout\csname #1@idxfile\endcsname}%
   {\immediate\closeout\csname #1@idxfile\endcsname
      \Ifstr{#1}{passages}{%
         \ClassInfo{brill}{Start modifying passages for sorting ...}%
         \directlua{modifySorting()}%
         \ClassInfo{brill}{... done.}%
      }%
      {%
         \Ifstr{#1}{words}{%
            \ClassInfo{brill}{Start modifying words for sorting ...}%
            \directlua{modifySorting_words()}%
            \ClassInfo{brill}{... done.}%
         }%
      }%
   }%
   {\ClassInfo{brill}{\string\imki@putindex\space successfully patched!}}%
   {\ClassInfo{brill}{\string\imki@putindex\space could not be patched!}}%
\patchcmd{\imki@putindex}%
   {\@input@{#1.ind}}%
   {%
      \Ifstr{#1}{passages}%
         {%
            \IfFileExists{passages-final.ind}%
               {\@input@{passages-final.ind}}%
               {\@input@{passages-mod.ind}}%
         }%
         {%
            \Ifstr{#1}{words}%
               {%
                  \IfFileExists{words-mod.ind}%
                     {\@input@{words-mod.ind}}%
                     {\@input@{#1.ind}}%
               }%
               {\@input@{#1.ind}}%
          }%
   }%
   {\ClassInfo{brill}{\string\imki@putindex\space successfully patched!}}%
   {\ClassInfo{brill}{\string\imki@putindex\space could not be patched!}}%   
\patchcmd{\imki@putindex}%  
   {\imki@exec{\imki@program\imki@options#1.idx}}%
   {%
      \ifboolexpr{ test {\Ifstr{#1}{passages}} or test {\Ifstr{#1}{words}} }%
         {\imki@exec{\imki@program\imki@options#1-mod.idx}}%
         {\imki@exec{\imki@program\imki@options#1.idx}}%
   }%
   {\ClassInfo{brill}{\string\imki@putindex\space successfully patched!}}%
   {\ClassWarning{brill}{\string\imki@putindex\space could not be patched!}}%
\patchcmd{\theindex}%
   {\begin{multicols}}%
   {\vspace*{-\normalbaselineskip}\begin{multicols}}%
   {\ClassInfo{brill}{\string\theindex\space successfully patched!}}%
   {\ClassWarning{brill}{\string\theindex\space could not be patched!}}%

\newcommand{\printindexes}{%
   \let\indexspace\relax%
   \begingroup%
      \renewcommand*{\subitem}{%
         \par%
         \iffirst@subitem%
            \nobreak%
            \first@subitemfalse%
         \else%
            \penalty 2000%
         \fi%
         \hangindent 2\normalparindent\relax}%
      \renewcommand*{\@idxitem}{%
         \par\addvspace{\baselineskip}\first@subitemtrue\relax}%
      \ifbrill@printindexwords
         \printindex[words]%
      \fi%
      \ifbrill@printindexpassages
         \printindex[passages]%
      \fi%
   \endgroup%
   \ifbrill@printindexnames
      \printindex[namesandsubjects]%
   \fi%
}
\ifbrill@PhD
   \makeindex[%
      name=words,%
      title={Index of Words},%
      columns=3,%
      columnsep=4mm,%
      options={-u -l av -n -c muya}%
   ]%
   \makeindex[%
      name=passages,%
      title={Index of Passages},%
      columns=3,%
      columnsep=4mm,%
      options={-n -c muyaPassages}%
   ]%
   \makeindex[%
      name=namesandsubjects,%
      title={Index of Names and Subjects},%
      columns=3,%
      columnsep=4mm,%
      options={-n -c brill}%
   ]%
\else
   \makeindex[%
      name=words,%
      title={Index of Words},%
      columns=2,%
      columnsep=4mm,%
      options={-u -l av -n -c muya}%
      ]%
   \makeindex[%
      name=passages,%
      title={Index of Passages},%
      columns=2,%
      columnsep=4mm,%
      options={-n -c muyaPassages}%
      ]%
   \makeindex[%
      name=namesandsubjects,%
      title={Index of Names and Subjects},%
      columns=2,%
      columnsep=4mm,%
      options={-n -c brill}%
      ]%
\fi%   

\newcommand*{\indexheaderfont}[1]{\textbf{#1}}

\protected\def\Word{\@ifstar{\@indexwords}{\@dblarg\@@indexwords}}
\newcommand{\@indexwords}[1]{%
   \StrCut*{#1}{!}{\@leftword}{\@rightword}%
   \ifstrempty{\@rightword}% no '!' in Argument
      {\index[words]{%
       \indexlanguage{}@\indexheaderfont{\indexlanguage}!#1@\idxentryfont{#1}}%
      }%
      {\index[words]{%
       \indexlanguage{}@\indexheaderfont{\indexlanguage}!#1@\idxentryfont{\@rightword}}%
      }%
}%
\newcommand{\@@indexwords}[2][]{%
%   \StrDel{#1}{-}[\@@@rest]
%   \StrDel{\@@@rest}{.}[\@@rest]
%   \StrDel{\@@rest}{ }[\@rest]
   \index[words]{%
      \indexlanguage{}@\indexheaderfont{\indexlanguage}!#1@\idxentryfont{#1}}%
   #2%
   \index[words]{%
      \indexlanguage{}@\indexheaderfont{\indexlanguage}!#1@\idxentryfont{#1}}%
}%

\protected\def\Passage{\@ifstar{\@indexpassages}{\@dblarg\@@indexpassages}}
\newcommand{\@indexpassages}[1]{%
   \index[passages]{%
      \indexlanguage{}@\indexheaderfont{\indexlanguage}!#1@\textup{#1}%
   }%
}
\newcommand{\@@indexpassages}[2][]{%
   \index[passages]{\indexlanguage{}@\indexheaderfont{\indexlanguage}!#1}%
   \textup{#2}%
   \index[passages]{\indexlanguage{}@\indexheaderfont{\indexlanguage}!#1}%
}%

\protected\def\Name{\@ifstar%
   {\@indexnamesandsubjects}{\@dblarg\@@indexnamesandsubjects}}
\protected\def\Subject{\@ifstar%
   {\@indexnamesandsubjects}{\@dblarg\@@indexnamesandsubjects}}
\newcommand{\@indexnamesandsubjects}[1]{\index[namesandsubjects]{#1}}
\newcommand{\@@indexnamesandsubjects}[2][]{\index[namesandsubjects]{#1}#2}

\let\passage\Passage
\let\subject\Subject
\let\name\Name
\let\word\Word

\newcommand*{\indexlanguage}{A@General}
\newcommand*{\idxentryfont}[1]{#1}
\newcommand*{\resetlanguage}{%
   \gdef\indexlanguage{A@General}%
   \renewcommand*{\idxentryfont}[1]{##1}%
}
\newcommand{\ItalicsOrNot}[1]{%
   \IfStrEqCase{#1}{%
      {Aram}{\def\indexlanguage{Aramaic}\itshape}%
      {Arm}{\def\indexlanguage{Armenian}\itshape}%
      {Av}{\def\indexlanguage{Avestan}\itshape}%
      {Bactr}{\def\indexlanguage{Bactrian}\upshape}%
      {Chor}{\def\indexlanguage{Choresmian}\itshape}%
      {El}{\def\indexlanguage{Elamite}\itshape}%
      {Goth}{\def\indexlanguage{Gothic}\itshape}%
      {Grk}{\def\indexlanguage{Greek}\upshape}%
      {Guj}{\def\indexlanguage{Gujarati}\itshape}%
      {Hitt}{\def\indexlanguage{Hittite}\itshape}%
      {IE}{\def\indexlanguage{Proto-Indo-European}\itshape}%
      {IIr}{\def\indexlanguage{Proto-Indo-Iranian}\itshape}%
      {IMP}{\def\indexlanguage{Inscriptional Middle Persian}\itshape}%
      {Khot}{\def\indexlanguage{Khotanese}\itshape}%
      {Lat}{\def\indexlanguage{Latin}\itshape}%
      {Lith}{\def\indexlanguage{Lithuanian}\itshape}%
      {Luw}{\def\indexlanguage{Luwian}\itshape}%
      {MAv}{\def\indexlanguage{Middle Avestan}\itshape}%
      {MMP}{\def\indexlanguage{Manichaean Middle Persian}\itshape}%
      {MP}{\def\indexlanguage{Middle Persian (unspecified)}\itshape}%
      {Munji}{\def\indexlanguage{Munji}\itshape}%
      {NP}{\def\indexlanguage{New Persian}\itshape}%
      {OAv}{\def\indexlanguage{Old Avestan}\itshape}
      {OE}{\def\indexlanguage{Old English}\itshape}%
      {OHG}{\def\indexlanguage{Old High German}\itshape}%
      {OIrish}{\def\indexlanguage{Old Irish}\itshape}%
      {OP}{\def\indexlanguage{Old Persian}\itshape}%
      {Oss}{\def\indexlanguage{Ossetic}\itshape}%
      {OssD}{\def\indexlanguage{Digoron Ossetic}\itshape}%
      {OssI}{\def\indexlanguage{Iron Ossetic}\itshape}%
      {Parth}{\def\indexlanguage{Parthian}\itshape}%
      {Pashto}{\def\indexlanguage{Pashto}\itshape}%
      {PDE}{\def\indexlanguage{Present-Day English}\itshape}%
      {PGmc}{\def\indexlanguage{Proto-Germanic}\itshape}%
      {Phl}{\def\indexlanguage{Pahlavi}\itshape}%
      {Phltlt}{\def\indexlanguage{Pahlavi}\@morewordspace}%
      {PIE}{\def\indexlanguage{Proto-Indo-European}\itshape}%
      {Pli}{\def\indexlanguage{PāỊi}\itshape}%
      {Pra}{\def\indexlanguage{Prakrit}\itshape}%
      {PrIIr}{\def\indexlanguage{Proto-Indo-Iranian}\itshape}%
      {PrIr}{\def\indexlanguage{Proto-Iranian}\itshape}%
      {Pz}{\def\indexlanguage{Pāzand}\itshape}%
      {Shugni}{\def\indexlanguage{Shugni}\itshape}%
      {Skt}{\def\indexlanguage{Sanskrit}\itshape}%
      {Sogd}{\def\indexlanguage{Sogdian}\itshape}%
      {TochA}{\def\indexlanguage{Tocharian A}\itshape}%
      {TochB}{\def\indexlanguage{Tocharian B}\itshape}%
      {Ved}{\def\indexlanguage{Vedic}\itshape}%
      {Yidgha}{\def\indexlanguage{Yidgha}\itshape}%
      {ZD}{\def\indexlanguage{Zoroastrian Dari}\itshape}%
   }[\ClassWarning{brill}{Language `#1` unknown. Using category `General`}%
     \def\indexlanguage{A@General}\upshape]%
   \hyphenpenalty=\@M%
   \exhyphenpenalty=\@M%
}
%%% Define macros for languages
\protected\def\newlanguage{\@ifstar\@newlanguage\@@newlanguage}% 
\newcommand{\@newlanguage}[2]{%
   \expandafter\newrobustcmd\csname #1\endcsname[2][]{%
      \def\indexlanguage{#2}%
      \renewcommand*{\idxentryfont}[1]{####1}%
      \begin{nohyphens}\nosmallcaps ##2\end{nohyphens}%
      \ifstrempty{##1}{}{\ \enquote{##1}}%
      \resetlanguage}
   \newenvironment{#1Block}{%
      \def\indexlanguage{#2}%
      \renewcommand*{\idxentryfont}[1]{####1}%
      \begin{nohyphens}%
      \nosmallcaps%   
   }%
   {%
      \end{nohyphens}%
      \resetlanguage%
   }%           
}
\newcommand{\@@newlanguage}[2]{%
   \expandafter\newrobustcmd\csname #1\endcsname[2][]{%
      \def\indexlanguage{#2}%
      \renewcommand*{\idxentryfont}[1]{\textit{####1}}%
      \begin{nohyphens}\nosmallcaps\emph{##2}\end{nohyphens}%
      \ifstrempty{##1}{}{\ \enquote{##1}}%
      \resetlanguage} 
   \newenvironment{#1Block}{%
      \def\indexlanguage{#2}%
      \renewcommand*{\idxentryfont}[1]{\textit{####1}}%
      \begin{nohyphens}%
         \nosmallcaps\itshape}%
   {\end{nohyphens}%
    \resetlanguage}              
}

\newlanguage{Aram}{Aramaic}
\newlanguage{Arm}{Armenian}
\protected\def\Av{\@ifstar\@Av\@@Av}
\newcommand*{\@Av}[2][]{%
   \def\indexlanguage{Avestan}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \Word[#2]{\begin{nohyphens}\nosmallcaps\emph{#2}\end{nohyphens}}%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage}
\newcommand*{\@@Av}[2][]{%
   \def\indexlanguage{Avestan}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \begin{nohyphens}\nosmallcaps\emph{#2}\end{nohyphens}%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage}
\let\Avst\Av
\newcommand*{\Bactr}[3][]{%
   \def\indexlanguage{Bactrian}%
   \renewcommand*{\idxentryfont}[1]{##1}%
   \ifstrempty{#2}
      {/#3/}%
      {%
         \begin{nohyphens}\nosmallcaps #2\end{nohyphens}%
         \ifstrempty{#3}{}{\ /#3/}%
      }%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage}
\newlanguage{Blc}{Balōčī}
\let\Balochi\Blc
\newlanguage{Chor}{Choresmian}
\newlanguage{El}{Elamite}
\newlanguage{NP}{New Persian}
\let\Fa\NP
\newlanguage{Goth}{Gothic}
\newlanguage*{Grk}{Greek}
\newlanguage{Guj}{Gujarati}
\let\Gujr\Guj
\newlanguage{Hitt}{Hittite}
\newlanguage{IMP}{Inscriptional Middle Persian}
\newlanguage{Khot}{Khotanese}
\newlanguage{Lat}{Latin}
\newlanguage{Lith}{Lithuanian}
\newlanguage{Luw}{Luwian}
\newlanguage{MAv}{Middle Avestan}
\newlanguage{MMP}{Manichaean Middle Persian}
\newlanguage{MP}{Middle Persian (unspecified)}
\newlanguage{Munji}{Munji}
\newlanguage{OAv}{Old Avestan}
\let\origOE\OE
\let\OE\@undefined
\newlanguage{OE}{Old English}
\newlanguage{OHG}{Old High German}
\newlanguage{OIrish}{Old Irish}
\newcommand*{\OP}[2][]{%
   \@ifnextchar\bgroup{\@OP[#1]{#2}}{\@OP[#1]{#2}{}}}
\newcommand*{\@OP}[3][]{%
   \def\indexlanguage{Old Persian}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \begin{nohyphens}\nosmallcaps\textit{#2}\end{nohyphens}%
   \ifstrempty{#3}{}{\ [#3]}%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage%
   \xspace%
}
\newcommand*{\OPtlt}[2][]{%
   \def\indexlanguage{Old Persian}%
   \renewcommand*{\idxentryfont}[1]{##1}%
   \begin{nohyphens}\nosmallcaps #2\end{nohyphens}%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage}
\newlanguage{Oss}{Ossetic}
\newlanguage{OssD}{Iron Ossetic}
\newlanguage{OssI}{Iron Ossetic}
\newlanguage{Parth}{Parthian}
\newlanguage{Pashto}{Paṣ̌tō}
\newlanguage{PDE}{Present-Day English}
\newlanguage{PGmc}{Proto-Germanic}
\newif\if@PhlNoEmph
\newrobustcmd*{\Phl}{\@ifstar%
   {%
%%%      \directlua{luatexbase.add_to_callback("post_linebreak_filter",upright_punctuation,"upright_punctuation")}%
      \@PhlNoEmphtrue\@@@Phl%
%%%      \directlua{luatexbase.remove_from_callback("post_linebreak_filter",upright_punctuation,"upright_punctuation")}%
   }%
   {%
%%%      \directlua{luatexbase.add_to_callback("post_linebreak_filter",upright_punctuation,"upright_punctuation")}%
      \@PhlNoEmphfalse\@@@Phl%
%%%      \directlua{luatexbase.remove_from_callback("post_linebreak_filter",upright_punctuation,"upright_punctuation")}%
   }%
}
\newcommand*{\@@@Phl}{%
   % Check for optional argument
   \@ifnextchar[%
      {% Call another macro to see, whether we have a second optional argument
         \@@@@Phl%
      }%
      {% Call the normal command which works with at most one optional argument
         \@Phl%
      }%
}
\def\@@@@Phl[#1]{%
   % There is at least one optional argument. Check for second one.
   \@ifnextchar[%
      {% We have two optional arguments. Therefore #1 could be 'r'. Check
         \Ifstr{#1}{r}{\@Phlreverse}{\@Phl}%
      }%
      {% There is only one optional argument 
         \@Phl[#1]%
      }%
}
\newcommand*{\@Phl}[2][]{%
   \@ifnextchar\bgroup{\@@Phl[#1]{#2}}{\@@Phl[#1]{#2}{}}}
\newcommand*{\@@Phl}[3][]{%
   \def\indexlanguage{Pahlavi}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \if@PhlNoEmph%
      \ifstrempty{#2}
         {\ifstrempty{#3}{}{\begin{nohyphens}\nosmallcaps\@morewordspace #3\end{nohyphens}}}%
         {%
            \begin{nohyphens}\nosmallcaps #2\end{nohyphens}%
            \ifstrempty{#3}{}{\ \begin{nohyphens}\nosmallcaps\@morewordspace #3\end{nohyphens}}%
         }%
   \else%
      \ifstrempty{#2}
         {% We assume, that #2 and #3 are not both empty
            \textlangle{}\begin{nohyphens}\nosmallcaps\@morewordspace #3\end{nohyphens}\textrangle{}%
         }%
         {%
            \begin{nohyphens}\nosmallcaps\textit{#2}\end{nohyphens}%
            \ifstrempty{#3}
               {}%
               {\ \textlangle{}\begin{nohyphens}\nosmallcaps\@morewordspace #3\end{nohyphens}\textrangle{}}%
         }%
   \fi%
   % We assume, that #2 and #3 are not both empty
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage%
   \xspace%
}
\newcommand*{\@Phlreverse}[3][]{%
   \def\indexlanguage{Pahlavi}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \ifstrempty{#3}
      {\begin{nohyphens}\nosmallcaps\textit{(#2)}\end{nohyphens}}%
      {%
         \textlangle{}#3\textrangle{}%
         \ifstrempty{#2}{}{\ \begin{nohyphens}\nosmallcaps\textit{(#2)}\end{nohyphens}}%   
      }%
   % We assume, that #2 and #3 are not both empty
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage%
   \xspace%
}
\let\Phlv\Phl
\newcommand*{\Phltlt}[2][]{%
   \def\indexlanguage{Pahlavi}%
   \renewcommand*{\idxentryfont}[1]{##1}%
   \ifstrempty{#2}{}{\begin{nohyphens}\nosmallcaps\@morewordspace \textup{#2}\end{nohyphens}}%
   \ifstrempty{#1}{}{\unskip\ \enquote{#1}}%
   \resetlanguage}
\let\Phlvtlt\Phltlt
\newlanguage{PIE}{Proto-Indo-European}
\let\IE\PIE%
\newlanguage{Pli}{PāỊi}
\newlanguage{Pra}{Prakrit}
\newlanguage{PrIIr}{Proto-Indo-Iranian}
\let\IIr\PrIIr%
\newlanguage{PrIr}{Proto-Iranian}
\newlanguage{Pz}{Pāzand}
\newlanguage{Shughni}{Šuγnī}
\newlanguage{Skt}{Sanskrit}
\let\Sa\Skt
\newcommand*{\Sogd}[3][]{%
   \def\indexlanguage{Sogdian}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}%
   \ifstrempty{#2}
      {\ifstrempty{#3}{}{/#3/}}%
      {%
         \begin{nohyphens}\nosmallcaps\emph{\@morewordspace #2}\end{nohyphens}%
         \ifstrempty{#3}{}{\ /#3/}%
      }%
   \ifstrempty{#1}{}{\ \enquote{#1}}%
   \resetlanguage}
\newlanguage{TochA}{Tocharian A}
\newlanguage{TochB}{Tocharian B}
\newlanguage{Ved}{Vedic}
\let\VedSa\Ved
\newlanguage{Yidgha}{Yidγa}
\newlanguage{ZD}{Zoroastrian Dari}
\newlanguage{Waxi}{Waxī}
\newlanguage{Gilaki}{Gīlakī}
\newlanguage{Ormuri}{Ōrmuṛī}
\newlanguage{Zazaki}{Zāzākī}
\newlanguage{Parachi}{Parāčī}
\newlanguage{Yazghulami}{Yazγulāmī}
\newlanguage{Kurmanji}{Kurmanǰī}
%%%
\newenvironment{AvBlock}{%
   \def\indexlanguage{Avestan}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}\itshape\hyphenpenalty=\@M\exhyphenpenalty=\@M\relax}%
   {\resetlanguage}
\let\AvstBlock\AvBlock
\let\endAvstBlock\endAvBlock
\newenvironment{BactrBlock}{%
   \def\indexlanguage{Bactrian}%
   \renewcommand*{\idxentryfont}[1]{##1}\hyphenpenalty=\@M\exhyphenpenalty=\@M\relax}%
   {\resetlanguage}
\let\BalochiBlock\BlcBlock
\let\endBalochiBlock\endBlcBlock
\let\FaBlock\NPBlock
\let\endFaBlock\endNPBlock
\let\GujrBlock\GujBlock
\let\endGujrBlock\endGujBlock
\newenvironment{PhlBlock}{\def\indexlanguage{Pahlavi}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}\itshape\hyphenpenalty=\@M\exhyphenpenalty=\@M\relax}%
   {\resetlanguage}
\newenvironment{PhltltBlock}{\def\indexlanguage{Pahlavi}%
   \renewcommand*{\idxentryfont}[1]{##1}\hyphenpenalty=\@M\exhyphenpenalty=\@M\relax}%
   {\resetlanguage}
\let\PhlvBlock\PhlBlock
\let\endPhlvBlock\endPhlBlock
\let\PhlvtltBlock\PhltltBlock
\let\endPhlvtltBlock\endPhltltBlock
\let\IEBlock\PIEBlock
\let\endIEBlock\endPIEBlock
\let\IIrBlock\PrIIrBlock
\let\endIIrBlock\endPrIIrBlock
\let\SaBlock\SkrBlock
\let\endSaBlock\endSkrBlock
\newenvironment{SogdBlock}{%
   \def\indexlanguage{Sogdian}%
   \renewcommand*{\idxentryfont}[1]{\textit{##1}}\itshape\hyphenpenalty=\@M\exhyphenpenalty=\@M\relax}%
   {\resetlanguage}
\let\VedSaBlock\VedBlock
\let\endVedSaBlock\endVedBlock
%%%
\newcommand{\Fr}[1]{\foreignlanguage{french}{#1}}
\newcommand{\Ger}[1]{\foreignlanguage{ngerman}{#1}}
\newcommand{\En}[1]{\foreignlanguage{british}{#1}}
\newenvironment{FrBlock}{\begin{otherlanguage*}{french}}{\end{otherlanguage*}}
\newenvironment{GerBlock}{\begin{otherlanguage*}{ngerman}}{\end{otherlanguage*}}

%%% We define a ``meta macro'' to define all book macros in the same way
\def\newbook{\@dblarg\@newbook}
\def\@newbook[#1]#2{%
   \expandafter\newcommand\csname #2\endcsname[1]{\gls{#1}\nobreak\hspace{\fontdimen2\font}##1}%
}

% We need a second abbreviation list for the apparatus criticus
\newglossary{appcrit}{appcritin}{appcritout}{Sigla and Abbreviations Used in the Critical Apparatus}
\newglossarystyle{muyaac}{%
   \setglossarystyle{brill}%
   \renewenvironment{theglossary}%
      {%
         % We use \LTpre to correct the spacing; should be done automatically
         \setlength{\LTpre}{\dimexpr 0.5\normalbaselineskip\relax}%
         \setlength{\LTpost}{0pt}%
         \setlength{\widestabbreviationac}{0pt}%
         \begin{longtabu} to%
            \textwidth{@{}p{\widestabbreviationac}%
               @{\hspace*{\normalparindent}}>{\raggedright}X@{}}%
      }%
      {\end{longtabu}}%
      \renewcommand{\glossentry}[2]{%
         \@checkforwidestabbreviationac{##1}%
         \glsentryitem{##1}\glstarget{##1}{\glossentryname{##1}}\strut &
         \glossentrydesc{##1}\glspostdescription\space ##2\strut%
         \tabularnewline%
      }%
}%   
\newcommand*{\@listabbreviationsac}{}
\newcommand*{\@listabbreviationsacadd}{}
\newcommand*{\@listabbreviationsacremove}{}
\newcommand*{\@additemtoacaddlist}[1]{\listgadd{\@listabbreviationsacadd}{#1}}
\newcommand*{\@additemtoacremovelist}[1]{\listgadd{\@listabbreviationsacremove}{#1}}
\newcommand*{\@removeitemfromaclist}[1]{\listgremove{\@listabbreviationsac}{#1}}
\define@key{ac}{add}{\forcsvlist{\@additemtoacaddlist}{#1}}
\define@key{ac}{remove}{\forcsvlist{\@additemtoacremovelist}{#1}}
\newcommand*{\actitle}{Sigla and Abbreviations Used in the Critical Apparatus}
\define@key{ac}{title}{\renewcommand*{\actitle}{#1}}
\def\newabbreviationac{\@ifstar\@newabbreviationac\@@newabbreviationac}
\newcommand*{\@newabbreviationac}[4][]{%
   \newabbreviation[type=appcrit,#1]{#2}{#3}{#4}%
   \listgadd{\@listabbreviationsac}{#2}}
\newcommand*{\@@newabbreviationac}[4][]{%
   \newabbreviation[type=appcrit,#1]{#2}{\textup{#3}}{#4}}
\def\printabbreviationsac{\@ifstar\@printabbreviationsac\@@printabbreviationsac}
\newcommand{\@printabbreviationsac}[1][]{%
   \setkeys{ac}{#1}%
   % If the list of items to be removed is empty, do nothing. 
   % Otherwise go through the list and remove all list items from the overall
   % list.
   \ifdefempty{\@listabbreviationsacremove}%
      {% Now check, whether add option was given as well
         \ifdefempty{\@listabbreviationsacadd}%
            {% No additions, no removals. Add all entries to the abbreviation list
               \forlistloop{\glsadd}{\@listabbreviationsac}%
            }%
            {%
               % Clear list
%%%               \renewcommand*{\@listabbreviationsac}{}%
               % Add only specific entries
               \forlistloop{\glsadd}{\@listabbreviationsacadd}%
            }%
      }%
      {%
         \ifdefempty{\@listabbreviationsacadd}%
            {}%
            {%
               \ClassWarning{brill}{Key-value options `add` and `remove` can not be used together!\MessageBreak
               `add` option is ignored!}%
            }%
         \forlistloop{\@removeitemfromaclist}{\@listabbreviationsacremove}%
         \forlistloop{\glsaddNoNumber}{\@listabbreviationsac}%
      }%
   \begingroup%
      \renewcommand*{\glsgroupskip}{}%
      \renewcommand{\glossarypreamble}{\small}%
      \ifbrill@PhD
         \renewcommand*{\arraystretch}{1.4}%
      \fi%
      \renewcommand{\glossarysection}[2][]{}%
      \printabbreviations[type=appcrit,style=muyaac]%
   \endgroup%
}
\newcommand{\@@printabbreviationsac}[1][]{%
   \setkeys{ac}{#1}%
   % Same as above
   \ifdefempty{\@listabbreviationsacremove}%
   {% Now check, whether add option was given as well
      \ifdefempty{\@listabbreviationsacadd}%
      {% No additions, no removals. Add all entries to the abbreviation list
         \forlistloop{\glsaddNoNumber}{\@listabbreviationsac}%
      }%
      {%
         % Clear list
         %%%               \renewcommand*{\@listabbreviationsac}{}%
         % Add only specific entries
         \forlistloop{\glsaddNoNumber}{\@listabbreviationsacadd}%
      }%
   }%
   {%
      \ifdefempty{\@listabbreviationsacadd}%
         {}%
         {%
            \ClassWarning{brill}{Key-value options `add` and `remove` can not be used together!\MessageBreak
               `add` option is ignored!}%
         }%
      \forlistloop{\@removeitemfromaclist}{\@listabbreviationsacremove}%
      \forlistloop{\glsaddNoNumber}{\@listabbreviationsac}%
   }%
   \begingroup%
   \renewcommand*{\glsgroupskip}{}%
   \ifbrill@PhD
      \renewcommand*{\arraystretch}{1.4}%
   \fi%
   \printabbreviations[type=appcrit,title={\actitle},style=muyaac]%
   \endgroup%
}
%
% We define macros to be used (only) within the stanzas/apparatus criticus
% We need a special macro for hanging text based on \cs{newline} calls in the export
\newcounter{appcrnewline}
\newcounter{muyalinenumber}
\newcounter{linenumberforstanza}
\newtoggle{@setlinenumberforthisline}
\newcommand{\appcrnewline}{%
   \stepcounter{appcrnewline}%
   % Check whether we have to end a commentary passage
   \if@iscommentarytext
      % Last word of current line is a commentary
      % Store that information to be able to look back
      \global\@iscontinuedcommentarytexttrue%
      % Will the next line start with a commentary?
      % We check, whether a macro has been defined in the previous run
      \ifcsdef{commcont-\theappcrnewline}%
         {}%
         {% Next line starts with something else -> end passage
            \unskip\textrangle{}% closing bracket >
            \global\@iscommentarytextfalse%
         }%
   \else
      \global\@iscontinuedcommentarytextfalse%
   \fi%
   \@setlinenumberstatus%
   \par\noindent\hangindent\parindent\hangafter=1\relax%
   \@getlinenumberstatus%
}
\newcommand{\lastnewline}{%
   \stepcounter{appcrnewline}%
   \if@iscommentarytext
      \global\@iscontinuedcommentarytexttrue%
      \ifcsdef{commcont-\theappcrnewline}%
         {}%
         {% Next line starts with something else -> end passage
            \unskip\textrangle{}% closing bracket >
            \global\@iscommentarytextfalse%
         }%
   \else
      \global\@iscontinuedcommentarytextfalse%
   \fi%
   \@setlinenumberstatus%
   \par%
}

% We need to know whether we have the first reading
\newif\if@firstrdg

% The main macro steps the counter for the \enquote{footnotes} and starts a list
\newtoggle{@inapp}
\newrobustcmd{\app}[1]{%
   \refstepcounter{appcrfootnote}%
   \unskip\kern0.05em\realsuperscript{\theappcrfootnote}%
   \@firstrdgtrue
   \gappto{\@appcr}{\toggletrue{@inapp}}%
   \gappto{\@appcr}{\item }#1%
   \gappto{\@appcr}{\togglefalse{@inapp}}%
}
% We define a macro for ritual directions
% The normal macro starts with a newline and some spacing while the starred
% variant starts rightaway.
\newif\if@startwithnewline
\@startwithnewlinetrue
\newif\if@inrd
\newif\if@rdlast
\newcommand{\rdlast}{\@rdlasttrue\rd}
\newcommand{\rd}{\@ifstar%
   {\@startwithnewlinefalse\@rd}{\@startwithnewlinetrue\@rd}}

\newcommand{\@rd}[1]{%TODO: Spacing
   \@inrdtrue%
   \global\settoggle{@setlinenumberforthisline}{false}%
   \if@editedtextonly\else
      %TODO: Why do we need this?
      %\if@startwithnewline\par\vspace{.5\baselineskip}\fi%
      \if@startwithnewline\par\addvspace{1\baselineskip}\fi%
      \begingroup%
         %\let\newline\appcrnewline%
         \tolerance=1%
         \emergencystretch=\maxdimen%
         \hyphenpenalty=\@M%
         %\exhyphenpenalty=\@M%
         \hbadness=\@M%
         \noindent% 
         \hangindent\parindent\hangafter=1\relax%
         \@getlinenumberstatus%
         #1\par\nobreak\if@rdlast\else\addvspace{1\baselineskip}\fi\noindent%
      \endgroup%
   \fi%
   \@inrdfalse%
   \@rdlastfalse%
   \hangindent\parindent\hangafter=1\relax%
   \ignorespaces%
%   \global\settoggle{@setlinenumberforthisline}{true}%
}
% We need to know, whether it's the first witness (sub)class call
\newif\if@firstwitclass
\newif\if@firstwitsubclass
\newif\if@subreading
% We define a macro for the readings. As this macro can have two optional 
% arguments, we read the first and remember whether it is empty or not
\newcommand{\rdg}[1][]{%
   \ifstrempty{#1}{\@subreadingfalse}{\@subreadingtrue}%
   % Call main macro
   \@rdg
}
% #1: Abbreviation for subreading
% #2: Witnesses
% #3: Reading
\newcommand{\@rdg}[3][]{%
   % If it is not the first reading, add a \cs{par} to the output
   \if@firstrdg\@firstrdgfalse\else\gappto{\@appcr}{\par}\fi%
   % If it is a subreading (non-empty first opt. argument) then start a 
   % nested list (either with label or without depending on second 
   % optional argument)
   \if@subreading
      \ifstrempty{#1}%
         {\gappto{\@appcr}{\begin{appcrenum}\item[]\strut}}%
         {\gappto{\@appcr}{\begin{appcrenum}\item[]\makebox[1.25\normalparindent][l]{#1\strut}}}%
   \fi%
   \@firstwitclasstrue%
   \@firstwitsubclasstrue%
   % Add reading to apparatus variable
   \gappto{\@appcr}{\strut\textit{#3}\ \begingroup\frenchspacing}%
   % Evaluate witnesses 
   #2%
   \gappto{\@appcr}{\endgroup}%
   % Close nested list if necessary
   \if@subreading
      \gappto{\@appcr}{\end{appcrenum}}%
   \fi%
}
% Write witness to apparatus
\newcommand{\wit}[1]{\gappto{\@appcr}{\strut #1 }}
 
\newcommand{\witclass}[1]{%
   % If this is not the first witness class call, insert punctuation
   \if@firstwitclass%
      \@firstwitclassfalse%
   \else%
      \@firstwitsubclasstrue\gappto{\@appcr}{\unskip;\ }%
   \fi%
   % Evaluate witness class entries
   #1%
}

\newcommand{\witsubclass}[1]{%
   % If this is not the first witness class call, insert punctuation
   \if@firstwitsubclass%
      \@firstwitsubclassfalse%
   \else%
      \gappto{\@appcr}{\unskip,\ }%
   \fi%
   %  Evaluate witness subclass entries
   #1%
}

% We manually count the words/footnotes in our editorial texts based 
% on \cs{app} calls
\newcounter{stanza}
\newcounter{appcrfootnote}[stanza]
\renewcommand{\theHappcrfootnote}{\thestanza.\arabic{appcrfootnote}}
\newcounter{nextappcrfootnote}
% We define a list of two levels
\newlist{appcrenum}{enumerate}{2}
\newcommand*{\appcrenumlabelfont}{%
   \addfontfeatures{Numbers={Tabular,Lining}}\scriptsize}
\setlist[appcrenum]{font=\appcrenumlabelfont,align=left}
\setlist[appcrenum,1]{%
   label=\arabic*,%
   leftmargin=*,%
   widest=88,%
   itemsep=.25\baselineskip plus .1\baselineskip minus .1\baselineskip,%
   parsep=0pt%
}

\setlist[appcrenum,2]{%
   label=\relax,%
   left=.5\normalparindent,%
   nosep%
}

\let\@MUYAminisec\minisec
\long\def\minisec{\@minisec}
\newcommand{\@minisec}[2][]{\@MUYAminisec{#2}}
% Each stanza starts a new mini section and resets the \enquote{footnote} counter
\newenvironment{stanza}[1]{%
   \stepcounter{stanza}%
   \Ifstr{\@stanzaheading}{none}%
      {}%
      {%
         \iftoggle{@stanzabooktoindex}%
            {\@stanzaheading[#1]{\Av{\passage{#1}}}}%
            {\@stanzaheading{#1}}%
      }%
   % The apparatus is stored in a variable
   \gdef\@appcr{}%
   \hyphenpenalty=\@M%
   \exhyphenpenalty=\@M%
   \if@inblocktranslation%
   \else%
      \let\newline\appcrnewline%
      \let\\\appcrnewline%
      \par\hangindent\parindent\hangafter=1\noindent\ignorespaces%
      % Check, whether to number _first_ line
      \@getlinenumberstatus%
   \fi%
}{%
   \global\settoggle{@setlinenumberforthisline}{false}%
   \par%
   % If the apparatus is not empty, output it in two columns
   \ifdefempty{\@appcr}{}{%
      \begin{multicols}{2}%
         \begin{appcrenum}\scriptsize\@appcr\end{appcrenum}
      \end{multicols}%   
   }%
}

\newcounter{minoreditionsection}
\newcounter{mesfootnote}
\newrobustcmd{\mesfootnote}[1]{%
   \refstepcounter{mesfootnote}%
   \unskip\kern0.05em\realsuperscript{\themesfootnote}%
   \edef\@currentmesfootnote{\noexpand\gappto\noexpand\@mes{\noexpand\item[\themesfootnote] #1}}%
   \@currentmesfootnote%
}
\newenvironment{minoreditionsection}[1]{%
   \stepcounter{minoreditionsection}%
   \setcounter{mesfootnote}{0}%
   %\setcounter{mesfootnote}{\value{footnote}}%
   \addsecnum*{#1}%
   % The apparatus is stored in a variable
   \gdef\@mes{}%
   \hyphenpenalty=\@M%
   \exhyphenpenalty=\@M%
   \let\footnote\mesfootnote%
}{%
   \par%
   % If the apparatus is not empty, output it in two columns
   \ifdefempty{\@mes}{}{%
      \begin{multicols}{2}%
         \begin{appcrenum}\scriptsize\@mes\end{appcrenum}%
      \end{multicols}%   
   }%
   %\setcounter{footnote}{\value{mesfootnote}}%
}

\newif\if@firstimportstanzas
\@firstimportstanzastrue
\def\Importstanzas{\@ifstar{\@Importstanzas[-transcript]}{\@Importstanzas}}
\newcommand*{\@Importstanzas}[2][]{%
   % This macro should only be called in the preamble of a document
   %\@onlypreamble
   % If this is the first call of the macro, then create the output file.
   % An existing file from a previous run is currently overwritten.
   % TODO: Compare file dates to decide, whether to reread a file
   \if@firstimportstanzas
      \directlua{create_stanzafile()}%
      \@firstimportstanzasfalse%
   \fi%
   % Delay call until \begin{document} (if file exists)
   \IfFileExists{#2}%
      {\AtBeginDocument{\directlua{read_stanzas_from_file("\luaescapestring{\detokenize{#2}}","\luaescapestring{\detokenize{#1}}")}}}%
      {\ClassError{brill}{File `#2` could not be found!}{}}%
}

% After all other \AtBeginDocument code we read the stanzas.tex file (if it exists)
\AfterEndPreamble{%
   \InputIfFileExists{./stanzas.tex}%
      {\ClassInfoNoLine{brill}{Stanza macros successfully loaded from `stanzas.tex`!}}%
      {\ClassWarningNoLine{brill}{There is no file `stanzas.tex`. No stanzas read!}}%
}

% We define key-value options for \Getstanza

\newcommand{\@defaultstanzaheading}{\minisec}
\newcommand{\SetDefaultStanzaheading}[1]{%
   \renewcommand{\@defaultstanzaheading}{#1}}
\newcommand{\@stanzaheading}{\@defaultstanzaheading}
\newtoggle{@stanzabooktoindex}
\settoggle{@stanzabooktoindex}{true}
\newcommand*{\SetDefaultStanzabooktoindex}[1]{%
   \settoggle{@stanzabooktoindex}{#1}}
\newtoggle{@stanzalinenumbers}
\define@key{stanza}{heading}{\renewcommand{\@stanzaheading}{#1}}
\define@key{stanza}{booktoindex}[true]{\settoggle{@stanzabooktoindex}{#1}}
\define@key{stanza}{linenumbers}[true]{\settoggle{@stanzalinenumbers}{#1}}

% Define macro \Getstanza[heading]{reference}
\newcommand{\Getstanza}[2][]{%
   \setkeys{stanza}{heading=\@defaultstanzaheading,#1}%
   \ifcsdef{stanza-#2}%
      {%
         \begingroup%
         \addfontfeatures{Ligatures=NoCommon}%
         \csuse{stanza-#2}%
         \endgroup%
      }%
      {\ClassError{brill}%
         {Stanza `#2` could not be read}{There is no macro for stanza `#2`}}%
}

\newif\if@editedtextonly
\newcommand{\GetstanzaTextonly}{\@ifstar%
   {\@editedtextonlytrue\@GetstanzaTextonly}%
   {\@editedtextonlyfalse\@GetstanzaTextonly}%
}
\newcommand{\@GetstanzaTextonly}[2][]{%
   \setkeys{stanza}{heading=\@defaultstanzaheading,#1}%
   \iftoggle{@stanzalinenumbers}{\setcounter{linenumberforstanza}{1}}{}%
   \ifcsdef{stanza-#2}%
      {%
         \begingroup%
            \let\app\@gobble%
            \addfontfeatures{Ligatures=NoCommon}%
            \csuse{stanza-#2}%   
         \endgroup%
      }%
      {\ClassError{brill}%
         {Stanza `#2` could not be read}{There is no macro for stanza `#2`}}%
}

% Define a macro to convert a book string like Y28.1 into a control sequence like \Y{28.1}
\newcommand{\bookstringtocs}[1]{%
   \directlua{strtocs("\luaescapestring{\detokenize{#1}}")}}

\newif\if@inblocktranslation
\newtoggle{@getstanzaWithRD}
\newtoggle{@getstanzaWithRDdefault}
\newcommand*{\SetDefaultGetstanzaWithtranslationWithRD}[1]{%
   \settoggle{@getstanzaWithRD}{#1}%
   \settoggle{@getstanzaWithRDdefault}{#1}%
}
% Define a macro to output the stanza text and its translation as 
% blocktranslation
% #1 is the reference of a stanza, e.g. Y28.1
% The starred version uses the -transcript variant of the stanza imported with
% \Importstanzas*{file} and the common translation
\newcommand{\GetstanzaWithtranslation}{\@ifstar%
   {%
      \iftoggle{@getstanzaWithRDdefault}%
         {\toggletrue{@getstanzaWithRD}}%
         {\togglefalse{@getstanzaWithRD}}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \iftoggle{@getstanzaWithRDdefault}%
         {\toggletrue{@getstanzaWithRD}}%
         {\togglefalse{@getstanzaWithRD}}%
      \@GetstanzaWithtranslation%
   }%
}

% We also define a version, which does not break across pages.
\newcommand{\GetstanzaWithtranslationNB}{\@ifstar%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
         \iftoggle{@getstanzaWithRDdefault}%
            {\toggletrue{@getstanzaWithRD}}%
            {\togglefalse{@getstanzaWithRD}}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
      \iftoggle{@getstanzaWithRDdefault}%
         {\toggletrue{@getstanzaWithRD}}%
         {\togglefalse{@getstanzaWithRD}}%
      \@GetstanzaWithtranslation%
   }%
}

\newcommand{\GetstanzaWithtranslationNBWithRD}{\@ifstar%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
      \settoggle{@getstanzaWithRD}{true}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
      \settoggle{@getstanzaWithRD}{true}%
      \@GetstanzaWithtranslation%
   }%
}

\newcommand{\GetstanzaWithtranslationNBWithoutRD}{\@ifstar%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
      \settoggle{@getstanzaWithRD}{false}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \settoggle{@blocktranslationNobreak}{true}%
      \settoggle{@getstanzaWithRD}{false}%
      \@GetstanzaWithtranslation%
   }%
}

% The existing macro does not take the ritual direction into account.
% Thus a separate macro is defined. The default behaviour can be set with a 
% special macro.
\newcommand{\GetstanzaWithtranslationWithRD}{\@ifstar%
   {%
      \settoggle{@getstanzaWithRD}{true}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \settoggle{@getstanzaWithRD}{true}%
      \@GetstanzaWithtranslation%
   }%
}

\newcommand{\GetstanzaWithtranslationWithoutRD}{\@ifstar%
   {%
      \settoggle{@getstanzaWithRD}{false}%
      \@GetstanzaWithtranslation[-transcript]%
   }%
   {%
      \settoggle{@getstanzaWithRD}{false}%
      \@GetstanzaWithtranslation%
   }%
}

\newcommand{\@GetstanzaWithtranslation}[2][]{%
   \if@intextandtranslation
      \paralleltypesetting%
         {\GetstanzaTextonly{#2#1}}%
         {\minisec{\bookstringtocs{#2}}\Gettranslation{#2}}%
   \else
      % Call the blocktranslation macro with appropriate arguments   
      \blocktranslation[\bookstringtocs{#2}]%
         {}%
         {%
            \iftoggle{@getstanzaWithRD}%
               {\GetstanzaTextonly[heading=none]{#2#1}}%
               {\GetstanzaTextonly*[heading=none]{#2#1}}%
         }%
         {%
            \iftoggle{@getstanzaWithRD}%
               {\Gettranslation{#2}}%
               {\Gettranslation*{#2}}%                
         }%
   \fi%
   \settoggle{@blocktranslationNobreak}{false}%
         \iftoggle{@getstanzaWithRDdefault}%
   {\toggletrue{@getstanzaWithRD}}%
   {\togglefalse{@getstanzaWithRD}}%
}

\newcommand{\GetstanzasWithtranslations}{\@ifstar%
   {\@GetstanzasWithtranslations[-transcript]}{\@GetstanzasWithtranslations}%
}
\newcommand{\@GetstanzasWithtranslations}[3][]{%
   \if@intextandtranslation
      \paralleltypesetting%
         {%
            \global\settoggle{@setlinenumberforthisline}{true}%
            \GetstanzaTextonly[linenumbers]{#2#1}%
         }%
         {%
            \global\settoggle{@setlinenumberforthisline}{true}%
            \reversemarginpar%
            \GetstanzaTextonly[linenumbers]{#3}% No opt. argument
         }%
      \paralleltypesetting%
         {%
            \global\settoggle{@setlinenumberforthisline}{true}%
            \Gettranslation[linenumbers]{#2}%
         }%
         {%
            \global\settoggle{@setlinenumberforthisline}{true}%
            \reversemarginpar%
            \Gettranslation[linenumbers]{#3}%
         }%
   \else
      \ClassError{brill}%
         {Macro `\GetstanzasWithtranslations` outside `textandtranslation` 
            environment}%
         {}%
   \fi%
}

\newif\if@substforeign
\newcounter{foreign@in@editedtext}
\newcommand{\GetstanzaWithtranscription}[1]{%
   \global\@substforeigntrue
   \setcounter{foreign@in@editedtext}{0}%
   \Getstanza{#1}%
   \global\@substforeignfalse
}
\newcommand{\GetstanzaTextonlyWithtranscription}[1]{%
   \global\@substforeigntrue
   \setcounter{foreign@in@editedtext}{0}%
   \GetstanzaTextonly{#1}%
   \global\@substforeignfalse
}

% Translation are stored in a common file translations.tex
% Each translation is defined with \Newtranslation[ritual direction]{label}{translation}
% translations and optional ritual direction are stored in a separate macro
\newcommand{\Newtranslation}[3][]{%
   \csgdef{translation-#2}{#3}%
   \ifstrempty{#1}{}{\csgdef{rd-#2}{#1}}%
}

% For conveniance
\let\newtranslation\Newtranslation

%\newtoggle{@translationlinenumbers}
\define@key{translation}{linenumbers}[true]{%
   \settoggle{@stanzalinenumbers}{#1}}
\newcommand*{\@rdposition}{}
\define@key{translation}{rdposition}{\renewcommand*{\@rdposition}{#1}}

\newcommand{\Gettranslation}{\@ifstar\@Gettranslation\@@Gettranslation}
\newcommand{\@Gettranslation}[1]{\@@Gettranslation[rdposition=none]{#1}}
\newcommand{\@@Gettranslation}[2][]{%
   \setkeys{translation}{#1}%
   \iftoggle{@stanzalinenumbers}{\setcounter{linenumberforstanza}{1}}{}%
   % Outside a blocktranslation we store the information, that we used a 
   % special \newline for the current line
   \if@inblocktranslation
   \else
      \refstepcounter{specialnewline}%
      \xdef\@currvalspecialnewline{\thespecialnewline}%
   \fi%
   \begingroup%
      \let\newline\@specialnewline%
      \let\\\@specialnewline%
      % No indention outside blocktranslation environment
      \if@inblocktranslation
      \else
         \setlength{\parindent}{0pt}%
      \fi%
      \IfStrEqCase{\@rdposition}{%
         {t}{%
            \par\noindent%
            \ifcsdef{rd-#2}{\csuse{rd-#2}\par\addvspace{\baselineskip}}{}%
            \csuse{translation-#2}%
         }%
         {m}{}%
         {b}{%
            \par\noindent%
            \csuse{translation-#2}%
            \ifcsdef{rd-#2}{\par\addvspace{\baselineskip}\csuse{rd-#2}}{}%
         }%
         {none}{%
            \let\RDTrans\@gobble%
            \csuse{translation-#2}%
            \par%
         }%
      }[%
         % We have to check, whether the first line is long and needs the 
         % special layout with hanging lines
         \ifcsdef{specialnewline\@currvalspecialnewline}%
            {\@@linebreakwithindent\addvspace{\baselineskip}}%
            {\par\addvspace{\baselineskip}\noindent}%
         \ifcsdef{translation-#2}%
            {%
               % Number _first_ line (if needed)
               \@getlinenumberstatus%
               % Output translation
               \csuse{translation-#2}%
               % Check, whether _last_ line has to be numbered
               \@setlinenumberstatus%
               % add new line marker (without any line numbering stuff)
               \@@linebreakwithindent%
            }%
            {\ClassWarning{brill}{No translation found for #2}}%
      ]%
   \endgroup%
}

% For convenience
\let\gettranslation\Gettranslation

% We need a special environment for typesetting of text and translation (or any
% other two corresponding texts) on facing pages
% We define a main text frame and two dynamic frames based on the flowfram 
% package
% The idea comes from https://tex.stackexchange.com/questions/165019/parallel-paragraphs-across-odd-and-even-pages
%\newflowframe{\textwidth}{\dimexpr\textheight-\baselineskip\relax}%
%   {0pt}{0pt}[main]
%\newdynamicframe[odd]{\textwidth}{\dimexpr\textheight-\baselineskip\relax}%
%   {0pt}{0pt}[translation]
%\newdynamicframe[even]{\textwidth}{\dimexpr\textheight-\baselineskip\relax}%
%   {0pt}{0pt}[text]
%
%% \checkisroom{idl}{text}
%\providecommand{\@gobblethree}[3]{}
%% Define a temporary box and a test macro
%\newsavebox\tmpsbox
%\newif\ifenoughroom
%\newcommand{\checkisroom}[2]{%
%   \bgroup
%   % get the frame's idn (stored in \ff@id)
%   \@dynamicframeid{#1}%
%   % temporarily suspend writing to external files
%   \let\protected@write\@gobblethree
%   % put the frame's contents and the pending text into 
%   % the temporary sbox
%   \begin{lrbox}{\tmpsbox}%
%      \begin{minipage}{\textwidth}%
%         \csname @dynamicframe@\romannumeral\ff@id\endcsname
%         \par
%         #2%
%      \end{minipage}%
%   \end{lrbox}%
%   % Does it fit the page?
%   \settoheight{\@ff@tmp@y}{\usebox\tmpsbox}%
%   \settodepth{\dimen@ii}{\usebox\tmpsbox}%
%   \addtolength{\@ff@tmp@y}{\dimen@ii}%
%   \ifdim\@ff@tmp@y>\textheight
%      \global\enoughroomfalse
%   \else
%      \global\enoughroomtrue
%   \fi%
%   \egroup
%}
%
%% \getcontentsheight{length}{text}
%\newcommand{\getcontentsheight}[2]{%
%   \bgroup
%   \let\protected@write\@gobblethree
%   \begin{lrbox}{\tmpsbox}%
%      \begin{minipage}{\textwidth}%
%         #2%
%      \end{minipage}%
%   \end{lrbox}%
%   \settoheight{\@ff@tmp@y}{\usebox\tmpsbox}%
%   \settodepth{\dimen@ii}{\usebox\tmpsbox}%
%   \addtolength{\@ff@tmp@y}{\dimen@ii}%
%   \global#1=\@ff@tmp@y\relax
%   \egroup
%}
%
%%\newcounter{heading}
%\newlength\blockheight
%\newif\if@firstblock
%\newcommand{\blocksep}{%
%   \if@firstblock
%      \par%
%      \global\@firstblockfalse%
%   \else
%      \par\vspace{\baselineskip}%
%   \fi%   
%}
%
%% \annote{annotation}{text}
%
\newcommand{\paralleltypesetting}[2]{#1\par#2}%
%\newcommand{\paralleltypesetting}[2]{%
%   % get height of the first argument
%   \getcontentsheight{\blockheight}{#1}%
%   % save it as the larger block (for now)
%   \def\largerblock{#1}%
%   % get height of the second argument
%   \getcontentsheight{\@ff@tmp@y}{#2}%
%   % check, whether it is larger than the first block
%   \ifdim\blockheight<\@ff@tmp@y
%      \blockheight=\@ff@tmp@y\relax
%      \def\largerblock{#2}%
%   \fi%
%   \edef\startblock{%
%      %\noexpand\global\noexpand\@firstblocktrue
%      \noexpand\blocksep
%      \noexpand\begin{minipage}[t][\the\blockheight]{\the\textwidth}%
%         \noexpand\setlength{\noexpand\parindent}{\the\parindent}%
%         %\noexpand\par\noexpand\noindent\noexpand\ignorespaces
%   }%
%   \checkisroom{translation}{\largerblock}%
%   \ifenoughroom
%      \@dynamicframeid{text}%
%      \expandafter\appenddynamiccontents\expandafter\ff@id
%      %\expandafter\global\expandafter\@firstblocktrue
%      \expandafter{%
%         \expandafter\blocksep%
%         \startblock#1%
%         \end{minipage}%
%      }%
%      \@dynamicframeid{translation}%
%      \expandafter\appenddynamiccontents\expandafter\ff@id
%      %\expandafter\global\expandafter\@firstblocktrue
%      \expandafter{%
%         \expandafter\blocksep%
%         \startblock#2%
%         \end{minipage}%
%      }%
%   \else
%      % output 2 pages
%      \cleartoeven
%      \@dynamicframeid{text}%
%      \expandafter\setdynamiccontents\expandafter\ff@id
%      \expandafter{\startblock#1\end{minipage}}%
%      \@dynamicframeid{translation}%
%      \expandafter\setdynamiccontents\expandafter\ff@id
%      \expandafter{\startblock#2\end{minipage}}%
%   \fi%
%   \par\vspace{\baselineskip}%
%}

\newcommand{\cleartoeven}{%
   \Ifthispageodd% KOMA macro
      {\newpage}%
      {\mbox{}\newpage\mbox{}\newpage}%
}
\def\muyalinenumber{}
%%% This macro is applied at the end of a line (when \\ or \newline is called)
%%% to store, whether or not this line gets a line number.
%%% It is the counterpart of macro \@getlinenumberstatus
\newcommand{\@setlinenumberstatus}{%
   \ifboolexpr{ bool {@innumberlines} and togl {@stanzalinenumbers} }% 
      {%
         \xdef\muyalinenumber{\themuyalinenumber}%
         % If the line should get a line number, write a corresponding macro
         % into th aux file.
         \iftoggle{@setlinenumberforthisline}%
            {%
               \immediate\write\@auxout{\csxdef{linenumber-\muyalinenumber}{}}%
            }%
            {}%
         % set variables for next line
         \refstepcounter{muyalinenumber}%
         % If we are still within ritual direction or commentary text, do not 
         % number the next line.
         \ifboolexpr{ bool {@inrd} 
                   or bool {@iscommentarytext}
                   or bool {@inRDTrans}}        
            {}%{\global\settoggle{@setlinenumberforthisline}{false}}%
            {\global\settoggle{@setlinenumberforthisline}{true}}%
      }{}%
}

%%% This macro is called at the beginning of a line, i.e. right after a \\ or
%%% \newline has been called.
\newcommand{\@getlinenumberstatus}{%
   \ifboolexpr{ bool {@innumberlines} and togl {@stanzalinenumbers} }% 
      {%
         \xdef\muyalinenumber{\themuyalinenumber}%
         % If a macro is defined for the current line, i.e. through the aux 
         % file from the previous run by \@setlinenumberstatus, then make a 
         % marginal note.
         \ifcsdef{linenumber-\muyalinenumber}%
            {%
               \marginnote{\thelinenumberforstanza}[.17\baselineskip]%
               \refstepcounter{linenumberforstanza}%
            }%
            {}%
      }{}%
}

\newif\if@intextandtranslation
\newif\if@innumberlines
\newenvironment{textandtranslation}{\par}{\par}
%\newenvironment{textandtranslation}%
%   {%
%      \global\@intextandtranslationtrue%
%      \global\@innumberlinestrue%
%      \cleartoeven
%      \setdynamiccontents*{text}{}%
%      \setdynamiccontents*{translation}{}%
%      %\global\@firstblocktrue%
%   }%
%   {%
%      \cleartoeven
%      \setdynamiccontents*{text}{}%
%      \setdynamiccontents*{translation}{}%
%      \global\@innumberlinesfalse%
%      \global\@intextandtranslationfalse%
%      %\settoggle{@stanzalinenumbers}{false}%
%   }%
%
%\AtEndDocument{\cleartoeven}

%%%
\newif\if@iscommentarytext
\newif\if@iscontinuedcommentarytext
\newrobustcmd*{\editedtext}[1]{%
   % We first check, whether we have to end a commentary passage
   \if@iscommentarytext
      \unskip\textrangle{} %
      \global\@iscommentarytextfalse
   \fi%
   \global\@iscontinuedcommentarytextfalse%
   % We test for specific texts and write them as they are.
   % All others get additional superscript numbers after each word.    
   \begingroup%
   %\editedtextfont
   \ifboolexpr{test { \Ifstrstart{#1}{(date, dedication of} }%
            or test { \Ifstr{#1}{(abbreviated text)} }}%
      {#1}%
      {%
         \ifx\app\@gobble
            {\itshape #1}%
         \else
            % we get the current value of appcrfootnote and add 1 -> this would
            % be the next footnote number
            \setcounter{nextappcrfootnote}{\value{appcrfootnote}}%
            \stepcounter{nextappcrfootnote}%
            {%
               \itshape%
               \StrSubstitute{#1}{ }%
                  {\kern0.05em%
                   \realsuperscript{\upshape\thenextappcrfootnote} }%
            }%
         \fi%
      }%
   \endgroup%
}
\let\editedtranslationtext\editedtext

\newcommand{\editedcommentarytext}[1]{% Adaption of \editedtext
   % We test for specific texts and write them as they are.
   % All others get additional superscript numbers after each word.    
   % Check, whether we are at the beginning of a line (following a \newline)
   % If so, we deactivate the line numbering.
   \ifvmode
      \global\settoggle{@setlinenumberforthisline}{false}%
   \fi%
   \Ifstrstart{#1}{(date, dedication of)}%
      {#1}%
      {% Check, whether this is the first commentary text
         \if@iscontinuedcommentarytext
         % This is the first word of a new line continuing a commentary 
         % from the previous line.
         % Store that info to be able to look ahead in the next run
            \immediate\write\@auxout%
               {\noexpand\csgdef{commcont-\theappcrnewline}{}}%  
            \global\@iscontinuedcommentarytextfalse
         \else
            \if@iscommentarytext
            % part of a one-line commentary text
            \else
            % start of a new commentary text passage
               \global\@iscommentarytexttrue
               \textlangle{}% opening bracket <; closing one after last \editedcommentarytext
            \fi%
         \fi%
         \ifx\app\@gobble
            {\itshape #1}%
         \else
         % we get the current value of appcrfootnote and add 1 -> this would
         % be the next footnote number
            \setcounter{nextappcrfootnote}{\value{appcrfootnote}}%
            \stepcounter{nextappcrfootnote}%
            {%
               \itshape%
               \StrSubstitute{#1}{ }%
                  {\realsuperscript{\upshape\thenextappcrfootnote} }%
            }%
         \fi%
      }%
}

\newcommand{\trcommentarytext}[1]{%
   \global\settoggle{@setlinenumberforthisline}{false}%
   \textlangle{}#1\textrangle{}%
}


% We need a macro for text portions within the Avestan (italic) text.
% In the XML these are <foreign> elements

\newrobustcmd*{\foreign}[2][]{%
   \if@substforeign
      \stepcounter{foreign@in@editedtext}%
%TODO: Check and fix this!%
      \Gettranscription{Y72.10-trans-\theforeign@in@editedtext}%
   \else
      \IfStrEqCase{#1}{%
         {pal-Avst}{\iftoggle{@inapp}{\textit{#2}}{\textit{#2}}}%
         {pal-Phlv}{\iftoggle{@inapp}{\textup{#2}}{\textit{#2}}}%
         {fa}{\iftoggle{@inapp}{\textup{#2}}{\textit{#2}}}%
         {ae-fa}{\iftoggle{@inapp}{\textup{#2}}{\textit{#2}}}%
      }[%
         \ClassWarning{brill}{Found unknown foreign language `#1`\MessageBreak%
            Result may not be as expected!}%
         \iftoggle{@inapp}{\textup{#2}}{\textit{#2}}]%
   \fi%
}

\newcommand{\Newtranscription}[3][]{%
   \csgdef{transcription-#2}{#3}%
   \ifstrempty{#1}{}{\csgdef{rd-#2}{#1}}%
}

% For convenience
\let\newtranscription\Newtranscription

\newcommand{\Gettranscription}[2][]{%
   %\ifcsdef{rd-#2}{\csuse{rd-#2}\par\vspace{\baselineskip}}{}%
   \ifcsdef{#2}%
      {\csuse{#2}}%
      {\ClassError{brill}{Transcription `#2` not found}{}}%
}

% For convenience
\let\gettranscription\Gettranscription

%%%
\newbook{A}
\newbook{AAM}
%\newcommand*{\A}[1]{\gls{A}\nobreakspace{}#1}% Afrinagan
%\newcommand*{\AAM}[1]{\gls{AAM}\nobreakspace{}#1}%
\newbook{Abu}
\newbook{AD}
\newbook{AG}
\newbook{AJ}
\newbook{AW}
\newbook{AM}
\newbook{AitB}
\newbook{Ank}
\newbook{Aog}
\newbook{ApSS}
\newbook{As}
\newbook{AV}
\newbook{AVS}
\newbook{AWN}
\newbook{Bd}
\newbook{BUK}
\newbook{CAP}
\newbook{DB}
\newbook{DNb}
\newbook{DD}
\newbook{Dhu}
\newbook{Dhy}
\newbook{Dk}
\newbook{DkM}
\newbook{DNa}
\newbook{DPd}
\newbook{DPe}
\newbook{DrYt}
\newbook{DuP}
\newbook{FiO}
\newbook{FiP}
\newbook{FrD}
\newbook{FrW}
%\newbook[G]{Gah}
\let\G\@undefined
\newbook{G}
\let\H\@undefined
\newbook{H}
\let\Herbedestan\H
\newbook{Hb}
\let\HB\Hb
\newbook{HN}
\newbook{KB}
\newbook{KN}
\newbook{KPT}
\newbook{Mbh}
\newbook{MHD}
\newbook{MKS}
\newbook{MS}
\newbook{MX}
\newbook{N}
\newbook{NiAb}
\newbook{NiAs}
\newbook{NiSY}
\newbook{NkB}
\newbook{NS}
\newbook{Ny}
\newbook{PaIr}
\newbook{PaPas}
\newbook{Par}
\newbook{PaXw}
\newbook{PazT}
\newbook{PNy}
\newbook{PRAF}
\newbook{PRDD}
\newbook{PS}
\newbook{PT}
\newbook{Pur}
\newbook{PV}
\newbook{PVr}
\newbook{PY}
\newbook{PYt}
\newbook{PWD}
\newbook{Ram}
\newbook{RV}
\let\origS\S
\let\S\@undefined
\newbook{S}
\let\Siroza\S
\newbook{SA}
\newbook{SBM}
\newbook{SCE}
\newbook{SBh}
\newbook{SdBd}
\newbook{SdN}
\newbook{SGW}
\newbook{ShahrEr}
\newbook{SnS}
\newbook{SrB}
\newbook{STi}
\newbook{STii}
\newbook{STSnS}
\newbook{SY}
\newbook{SYt}
\newbook{TB}
\newbook{TS}
\newbook{TSP}
\newbook{V}
\let\Vd\V
\newbook{ViDh}
\newbook{Vim}
\newbook{VN}
\newbook{Vr}
\newbook{VrS}
\newbook{VS}
\newbook{Vyt}
\newbook{VytS}
\newbook{WD}
\newbook{WZ}
\newbook{XPl}
\newbook{Y}
\newbook{YAv}
\newbook{YF}
\newbook{Yt}
\newbook{ZWY}

\newcommand{\AvTr}[1]{#1}
\newcommand{\Rd}[1]{#1}
%%%
\newif\if@usechapterref
\newcommand*{\Chapterref}[1]{\if@usechapterref\realsuperscript{\ref{#1}}\fi}
\let\chapterref\Chapterref
\newcommand*{\@abbreviationsfile}{../muya.common/abbreviations.tex}
\newcommand*{\SetAbbreviationsFile}[1]{\renewcommand*{\@abbreviationsfile}{#1}}
\newcommand*{\@abbreviationsacfile}{../muya.common/abbreviations_ac.tex}
\newcommand*{\SetAbbreviationsacFile}[1]{\renewcommand*{\@abbreviationsacfile}{#1}}
\newcommand*{\@transcriptionsfile}{../muya.common/transcriptions.tex}
\newcommand*{\SetTranscriptionsFile}[1]{\renewcommand*{\@transcriptionsfile}{#1}}
\newcommand*{\@translationsfile}{../muya.common/translations.tex}
\newcommand*{\SetTranslationsFile}[1]{\renewcommand*{\@translationsfile}{#1}}
%%\newcommand*{\@bibliographyfile}{../muya.common/zotero.bib}
%%\newcommand*{\SetBibliographyFile}[1]{\renewcommand*{\@bibliographyfile}{#1}}
\newcommand*{\@hyphexceptionsfile}{../muya.common/hyphenation-exceptions.tex}
\newcommand*{\SetHyphexceptionsFile}[1]{\renewcommand*{\@hyphexceptionsfile}{#1}}
\newcommand*{\@titlelogofile}{../muya.common/BRILL.pdf}
\newcommand*{\SetTitleLogoFile}[1]{\renewcommand*{\@titlelogofile}{#1}}

\newcommand*{\LemmaBasic}[2][]{\item[#2]}
\newlist{Dictionary*}{description}{1}
\setlist[Dictionary*]{%
   labelsep=0pt,%
   left=0pt .. 2\normalparindent,%
   itemindent=*,
   labelsep=4mm,%
   font=\normalfont\bfseries,%
   before={\let\Lemma\LemmaBasic\small},%
}

\newcommand{\anklink}[2]{#1\hfill\Ank{#2}}
\newcommand{\setdictlanguage}[1]{\def\@dictlanguage{#1}}
\NewEnviron{Dictionary}[1][Av]%
   {%
      \stepcounter{numberofglossaries}%
      \def\@dictlanguage{#1}%
   }%
   [{%
      \IfStrEqCase{\@dictlanguage}{%
         {Av}{\directlua{sortGlossary("Av")}}%
         {Guj}{\directlua{sortGlossary("Guj")}}%
         {MP}{\directlua{sortGlossary("MP")}}%
         {NP}{\directlua{sortGlossary("NP")}}%
         {Skt}{\directlua{sortGlossary("Skt")}}%
      }[\ClassWarning{brill}{Unknown language `\@dictlanguage`.}]
    }%
      \input{dictionaryconv}]%
% For the dictionary
\newif\if@firstsublemma
\newif\if@firstsubsublemma
\newif\if@firstsubsubsublemma
\newlist{ModDictionary}{description}{1}
\setlist[ModDictionary]{%
   leftmargin=*,%
   labelsep=0pt,%
   font=\normalfont\bfseries\itshape,%
}
\newlist{Meanings}{enumerate*}{1}
\setlist[Meanings]{label=\arabic*.,mode=unboxed}
%
\newlist{Sublemmata}{description}{1}
\setlist[Sublemmata]{%
   leftmargin=*,%
   labelindent=2\parindent,%
   labelsep=.5em,%
   font=\normalfont\bfseries\itshape,%
   before={\def~{\textasciitilde}\@firstsublemmatrue}%,
}
\newlist{Subsublemmata}{description}{1}
\setlist[Subsublemmata]{%
   leftmargin=*,%
   labelindent=2\parindent,%
   labelsep=.5em,%
   font=\normalfont\bfseries\itshape,%
   before={\def~{\textasciitilde}\@firstsubsublemmatrue}%
}
\newlist{Subsubsublemmata}{description}{1}
\setlist[Subsubsublemmata]{labelsep=.5em}
\setlist[Subsubsublemmata]{%
   leftmargin=*,%
   labelindent=2\parindent,%
   labelsep=.5em,%
   font=\normalfont\bfseries\itshape,%
   before={\def~{\textasciitilde}\@firstsubsubsublemmatrue}%
}
\newcommand{\Meaning}[2][]{\item #2\ifstrempty{#1}{}{\ (#1)}}
\def\Sublemma{\@ifstar\@Sublemma\@@Sublemma}
\newcommand*{\@Sublemma}[1]{%
   \if@firstsublemma
      \@@Sublemma{#1}%
      \@firstsublemmafalse%
   \else
      \unskip\nobreak\hspace{\fontdimen2\font}|\penalty9999\hspace{\fontdimen2\font}{\bfseries\itshape #1}%
   \fi%
}
\newcommand*{\@@Sublemma}[1]{%
   \item[#1]%
   \@firstattestationtrue%
   \@firstsublemmafalse%
}
%
\def\Subsublemma{\@ifstar\@Subsublemma\@@Subsublemma}
\newcommand*{\@Subsublemma}[1]{%
   \if@firstsubsublemma
      \@@Subsublemma{#1}%
      \@firstsubsublemmafalse%
   \else
      \unskip\nobreak\hspace{\fontdimen2\font}|\penalty9999\hspace{\fontdimen2\font}{\bfseries\itshape #1}%
   \fi%
}
\newcommand*{\@@Subsublemma}[1]{%
   \item[#1]%
   \@firstattestationtrue%
   \@firstsubsublemmafalse
}
%
\def\Subsubsublemma{\@ifstar\@Subsubsublemma\@@Subsubsublemma}
\newcommand*{\@Subsubsublemma}[1]{%
   \if@firstsubsubsublemma
      \@@Subsubsublemma{#1}%
      \@firstsubsubsublemmafalse
   \else
      \unskip\nobreak\hspace{\fontdimen2\font}|\penalty9999\hspace{\fontdimen2\font}{\bfseries\itshape #1}%
   \fi%
}
\newcommand*{\@@Subsubsublemma}[1]{%
   \item[#1]%
   \@firstattestationtrue%
   \@firstsubsubsublemmafalse%
}

\newcommand*{\Lemma}[2][]{\item[#2]\@ifnextchar,{}{\hspace{0.5em}}}
\newcommand*{\Lemmaoarg}[1]{\ifstrempty{#1}{}{\textlangle{}#1\textrangle{}}}
\newcommand*{\Link}[1]{\unskip\nobreakspace\symbol{"2192}\,#1}

\newcommand{\AirWb}[1]{\textit{AirWb}\nobreakspace{}#1}
\newcommand{\Etym}[1]{#1}
\newcommand{\EWAia}[1]{\textit{EWAia}\nobreakspace{}#1}
\newcommand{\Reference}[1]{#1}
\newcommand{\Translation}[2][]{%
   \IfStrEqCase{#1}{%
      {Phlv}{Pahl.\,tr.:\nobreakspace{}}%
      {Sa}{Sanskrit tr.:\nobreakspace{}}%
   }[]%
\textit{#2}}%
\newcommand{\Stage}[1]{#1}
%%\newcommand{\Ved}[1]{#1}
\newcounter{attestation}
\def\Attestation{\@ifstar%
   {\stepcounter{attestation}\@attestation}%
   {\setcounter{attestation}{1}\@attestation}}
\newif\if@firstattestation
\def\@attestation{\@ifnextchar[{\@@attestation}{\@@attestation[0]}}
\newcommand{\@@attestation}[3][]{%
   \if@firstattestation
      \@firstattestationfalse%
   \else%
      \unskip\nobreak\hspace{\fontdimen2\font}|\nobreak\hspace{\fontdimen2\font}\ignorespaces%
   \fi%
   \ifstrempty{#1}{}{\Ifstr{#1}{0}{\theattestation.}{#1.}}%
   \unskip\nobreak\hspace{\fontdimen2\font plus \fontdimen3\font minus \fontdimen4\font}%
   \begin{nohyphens}%
   \IfStrEqCase{\@dictlanguage}{%
      {Av}{\textit{#2}}%
      {Guj}{\textit{#2}}%
      {MP}{\textlangle{}#2\textrangle{}}%
      {NP}{\textlangle{}#2\textrangle{}}%
   }[\textit{#2}]%
   \end{nohyphens}%
   \ #3%
}%

\newcommand{\Pos}[1]{#1}

\ifltxcounter{numberofglossaries}%
   {}%
   {\newcounter{numberofglossaries}}%
\AtBeginDocument{\setcounter{numberofglossaries}{0}}
\newcounter{@numberofglossaries}
\newcommand{\Sequenceofletters}{%
   \par\noindent
   Sequence of letters:\\%
   \setcounter{@numberofglossaries}{\numexpr\value{numberofglossaries}+1\relax}
   \csuse{@sequenceofletters\the@numberofglossaries}%
   \par\vspace{\baselineskip}\noindent}

\newlength{\widestabbreviationac}

\newcommand*{\@checkforwidestabbreviationac}[1]{%
   \settowidth{\currentwidth}{#1}%
   \ifdimgreater{\currentwidth}{\widestabbreviationac}%
      {\global\setlength{\widestabbreviationac}{\currentwidth}}%
      {}%
}

\AtEndDocument{%
   \ifdimless{\widestabbreviationac}{\normalparindent}%
      {\immediate\write\@auxout%
         {%
            \noexpand\global%
            \noexpand\setlength{\widestabbreviationac}%
            {\dimexpr 1.0\dimexpr\the\normalparindent\relax \relax}%
         }%
      }{\ifdimless{\widestabbreviationac}{2\normalparindent}%
         {\immediate\write\@auxout%
            {%
               \noexpand\global%
               \noexpand\setlength{\widestabbreviationac}%
               {\dimexpr 2.0\dimexpr\the\normalparindent\relax \relax}%
            }%
         }{\ifdimless{\widestabbreviationac}{3\normalparindent}%
            {\immediate\write\@auxout%
               {%
                  \noexpand\global%
                  \noexpand\setlength{\widestabbreviationac}%
                  {\dimexpr 3.0\dimexpr\the\normalparindent\relax \relax}%
               }%
            }{\ifdimless{\widestabbreviationac}{4\normalparindent}%
               {\immediate\write\@auxout%
                  {%
                     \noexpand\global%
                     \noexpand\setlength{\widestabbreviationac}%
                     {\dimexpr 4.0\dimexpr\the\normalparindent\relax \relax}%
                  }%
               }{\ifdimless{\widestabbreviationac}{5\normalparindent}%
                  {\immediate\write\@auxout%
                     {%
                        \noexpand\global%
                        \noexpand\setlength{\widestabbreviationac}%
                        {\dimexpr 5.0\dimexpr\the\normalparindent\relax \relax}%
                     }%
                  }{\ifdimless{\widestabbreviationac}{6\normalparindent}%
                     {\immediate\write\@auxout%
                        {%
                           \noexpand\global%
                           \noexpand\setlength{\widestabbreviationac}%
                           {\dimexpr 6.0\dimexpr\the\normalparindent\relax \relax}%
                        }%
                     }{\immediate\write\@auxout%
                           {%
                              \noexpand\global%
                              \noexpand\setlength{\widestabbreviationac}%
                              {\dimexpr 7.0\dimexpr\the\normalparindent\relax \relax}%
                           }%
                     }%
                  }%
               }%
            }%
         }%
      }%
}%
%\newcolumntype{W}{>{\collectcell\testme}p{\widestabbreviationac}<{\endcollectcell}}
%\tabucolumn W

\AtEndPreamble{%
   \shorthandon{"}
   \InputIfFileExists{\@abbreviationsfile}%
      {\ClassInfo{brill}{Abbreviations successfully loaded!}}%
      {\ClassWarning{brill}{%
         No abbreviation file found!\MessageBreak
         Please use \string\SetAbbreviationsFile\space}%
      }%
   \InputIfFileExists{\@abbreviationsacfile}%
      {\ClassInfo{brill}{Abbreviations for apparatus criticus successfully    
         loaded!}}%
      {\ClassWarning{brill}{%
         No abbreviation file for apparatus criticus found!\MessageBreak
         Please use \string\SetAbbreviationsacFile\space}%
      }%
   \InputIfFileExists{\@translationsfile}%
      {\ClassInfo{brill}{Translations successfully loaded!}}%
      {\ClassWarning{brill}{%
         No translation file found!\MessageBreak
         Please use \string\SetTranslationsFile\space}%
      }%
   \shorthandoff{"}
   \IfFileExists{\@transcriptionsfile}%
      {%
         \directlua{read_transcriptions("\luaescapestring{\@transcriptionsfile}")}%
         \InputIfFileExists{transcriptions-mod.tex}%
            {%
               \ClassInfo{brill}{Transcriptions successfully loaded from `\@transcriptionsfile`!}%
            }%
            {%
               \ClassWarning{brill}{Problem with loading transcriptions from `\@transcriptionsfile`\MessageBreak No transcriptions available}%
            }%
      }%
      {%
         \ClassWarning{brill}{No transcription file found!\MessageBreak
         Please use \string\SetTranscriptionsFile\space}%
      }%
%   \IfFileExists{\@bibliographyfile}%
%      {\addbibresource{\@bibliographyfile}}%
%      {\ClassWarning{brill}{No bibliography file found!\MessageBreak
%       Please use \string\SetBibliographyFile\space}}%
   \InputIfFileExists{\@hyphexceptionsfile}%
      {\ClassInfo{brill}{Successfully loaded hyphenation exceptions file 
         ``\@hyphexceptionsfile''}%
      }%
      {\ClassInfo{brill}{Could not find hyphenations exceptions file 
         ``\@hyphexceptionsfile''!}%
      }%
}%

\DeclareRobustCommand*{\supth}{\textsuperscript{th}\xspace}
\DeclareRobustCommand*{\uncertain}[1]{#1\fakesuperscript{\textup{?}}}
\newcommand{\addblankline}[1][1]{\vspace{#1\baselineskip}}
\newcommand*{\footnotetextsuperscript}[1]{\textsuperscript{\upshape #1}}
\newcommand{\insertion}[1]{{\upshape #1}}
\newif\if@inRDTrans
\newcommand{\RDTrans}[1]{%
   \@inRDTranstrue%
   \global\settoggle{@setlinenumberforthisline}{false}%
   {\itshape #1}%
   \global\settoggle{@setlinenumberforthisline}{true}%
   \@inRDTransfalse%
}%
%
\let\@abstract\@empty%
\ifbrill@PhD
   \newcommand{\@degree}{}%
   \newcommand{\degree}[1]{\renewcommand{\@degree}{#1}}
   \newcommand{\department}[1]{\renewcommand{\@department}{#1}}
   \newcommand{\@department}{}%
   \def\abstract{\@ifstar%
      {\def\@abstractheading{\chapter*{\abstractname}%
         \markboth{\abstractname}{\abstractname}}%
       \@@abstract}%   
      {\def\@abstractheading{\addchap{\abstractname}}%
       \@@abstract}%
   }
   \newcommand{\@@abstract}[1]{\renewcommand{\@abstract}{#1}}%
   \newcommand{\declarationPhD}[1]{\renewcommand{\@declarationPhD}{#1}}%
   \newcommand{\@declarationPhD}{%
      \minisec{Declaration for SOAS PhD thesis}
   \noindent I have read and understood Regulation 21 of the General and 
   Admissions Regulations for students of the SOAS, University of London 
   concerning plagiarism. I undertake that all the material presented for 
   examination is my own work and has not been written for me, in whole or in 
   part, by any other person. I also undertake that any quotation or paraphrase 
   from the published or unpublished work of another person has been duly 
   acknowledged in the work which I present for 
   examination.\par\vspace{\baselineskip}
   \noindent Signed: \rule{4cm}{0.4pt} \hfill Date: \rule{4cm}{0.4pt}%
   }
\else
   \let\declarationPhD\@gobble
   \let\abstract\@gobble
\fi%
\pdfstringdefDisableCommands{%
   \renewcommand*{\@@Av}[2][]{#2}%
   \renewcommand*{\Guj}[2][]{#2}%
   \def\gls#1{#1}%
   \def\Y#1{Y~#1}%
   \def\PY#1{PY~#1}%
   \def\Phl#1{Phl~#1}%
}%

\AtBeginDocument{\let\brill@saved@footnotetext\@footnotetext}
\newcommand*{\Deactivatefootnotetext}{\let\@footnotetext=\@gobble}
\newcommand*{\Activatefootnotetext}{\let\@footnotetext\brill@saved@footnotetext}

\providecommand*{\fL}{\hskip0.16667em\relax}
\renewcommand{\slash}{/\penalty\exhyphenpenalty\hspace{0pt}}
\providecommand*{\nbthinslash}{\,\slash\fL{}}
\providecommand*{\appindent}{\hspace*{\normalparindent}}      
%\providecommand*{\Comment}{\noindent\textbf{Comment}:}
\providecommand*{\skipaftergraphic}%
   {\vspace*{\dimexpr -1.0\normalbaselineskip+1bp\relax}}

%\newcommand*\footnoteruleVAR{%
%   \normalsize\ftn@rule@test@values
%   \kern-\dimexpr 2.6\p@+\ftn@rule@height\relax
%   \ifx\@textbottom\relax\else\vskip \z@ \@plus.05fil\fi
%   {\usekomafont{footnoterule}{%
%         \hrule \@height\ftn@rule@height \@width\ftn@rule@width}}%
%   \kern 2.6\p@}
%
%\providecommand{\liftfootnotes}[1]{%
%      \advance\skip\footins by-#1%
%      \def\footnoterule{%
%         \normalsize\ftn@rule@test@values
%         \kern#1%
%         \kern-\dimexpr 2.6\p@+\ftn@rule@height\relax
%         \ifx\@textbottom\relax\else\vskip \z@ \@plus.05fil\fi
%         {\usekomafont{footnoterule}{%
%               \hrule \@height\ftn@rule@height \@width\ftn@rule@width}}%
%         %\kern 2.6\p@%
%         \kern-#1}%
%}
\endinput
